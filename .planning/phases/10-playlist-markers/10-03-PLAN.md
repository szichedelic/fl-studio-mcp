---
phase: 10-playlist-markers
plan: 03
type: execute
wave: 3
depends_on: ["10-02"]
files_modified:
  - fl-bridge/handlers/playlist.py
  - src/tools/playlist.ts
autonomous: true

must_haves:
  truths:
    - "User can trigger live clips in performance mode"
    - "User can stop clips on a playlist track"
    - "User can check live clip status"
  artifacts:
    - path: "fl-bridge/handlers/playlist.py"
      provides: "Live clip handlers (trigger_clip, stop_clips, get_live_status)"
      contains: "register_handler('playlist.trigger_clip'"
    - path: "src/tools/playlist.ts"
      provides: "MCP tools for live clips"
      contains: "trigger_live_clip"
  key_links:
    - from: "src/tools/playlist.ts"
      to: "fl-bridge/handlers/playlist.py"
      via: "connection.executeCommand('playlist.trigger_clip')"
      pattern: "executeCommand\\('playlist\\.trigger_clip'"
    - from: "fl-bridge/handlers/playlist.py"
      to: "FL Studio playlist module"
      via: "playlist.triggerLiveClip, getLiveStatus"
      pattern: "playlist\\.(triggerLiveClip|getLiveStatus)"
---

<objective>
Add live clip triggering handlers and MCP tools for performance mode clip control.

Purpose: Enable users to trigger and control live clips in FL Studio's Performance Mode (requirement PLAY-08).
Output: Extended playlist.py with live clip handlers, extended playlist.ts with live clip tools.
</objective>

<execution_context>
@C:\Users\jared\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\jared\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-playlist-markers/10-RESEARCH.md
@.planning/phases/10-playlist-markers/10-01-SUMMARY.md
@.planning/phases/10-playlist-markers/10-02-SUMMARY.md

# Files to extend
@fl-bridge/handlers/playlist.py
@src/tools/playlist.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add live clip handlers to playlist.py</name>
  <files>fl-bridge/handlers/playlist.py</files>
  <action>
Extend `fl-bridge/handlers/playlist.py` with live clip handlers:

1. Ensure `midi` module is imported (should be from earlier tasks, but verify):
   ```python
   try:
       import midi
   except ImportError:
       midi = None
   ```

2. Add handler `handle_playlist_trigger_clip(params)`:
   - Required params: `track` (int, 1-indexed), `block` (int, 0-indexed block number)
   - Validate track using `_validate_playlist_track(track)`
   - Call `playlist.triggerLiveClip(track, block, 0, -1)`:
     - `track`: 1-indexed playlist track
     - `block`: 0-indexed block number (or -1 to stop all on track)
     - `flags`: 0 = normal trigger
     - `velocity`: -1 = default (cycles through layers)
   - Get status after trigger: `playlist.getLiveStatus(track, midi.LB_Status_Default if midi else 0)`
   - Return `{success: True, track, block, status}`
   - NOTE: Document that Performance Mode must be enabled for clips to play

3. Add handler `handle_playlist_stop_clips(params)`:
   - Required params: `track` (int, 1-indexed)
   - Validate track using `_validate_playlist_track(track)`
   - Call `playlist.triggerLiveClip(track, -1, 0, -1)`:
     - `block=-1` stops all clips on the track
   - Return `{success: True, track, stopped: True}`

4. Add handler `handle_playlist_get_live_status(params)`:
   - Required params: `track` (int, 1-indexed)
   - Validate track using `_validate_playlist_track(track)`
   - Get status: `playlist.getLiveStatus(track, midi.LB_Status_Default if midi else 0)`
   - Return `{success: True, track, status}`
   - NOTE: Document status values in docstring

5. Register new handlers at bottom of file:
   ```python
   # Live clip handlers (Phase 10 Plan 03)
   register_handler('playlist.trigger_clip', handle_playlist_trigger_clip)
   register_handler('playlist.stop_clips', handle_playlist_stop_clips)
   register_handler('playlist.get_live_status', handle_playlist_get_live_status)
   ```

6. Update module docstring to include new handlers in REGISTERED HANDLERS section.
   Add note: "IMPORTANT: Live clip functions require Performance Mode to be enabled in FL Studio."
  </action>
  <verify>
    - `python -m py_compile fl-bridge/handlers/playlist.py` passes
    - File contains: `register_handler('playlist.trigger_clip'`
    - File contains: `register_handler('playlist.stop_clips'`
    - File contains: `register_handler('playlist.get_live_status'`
    - File contains: `playlist.triggerLiveClip`
    - File contains: `playlist.getLiveStatus`
    - File contains: `Performance Mode` (documentation note)
  </verify>
  <done>
    Python handlers for live clip control registered:
    - playlist.trigger_clip: triggers clip on track/block
    - playlist.stop_clips: stops all clips on a track
    - playlist.get_live_status: queries clip playback status
    - All handlers document Performance Mode requirement
  </done>
</task>

<task type="auto">
  <name>Task 2: Add live clip MCP tools to playlist.ts</name>
  <files>src/tools/playlist.ts</files>
  <action>
Extend `src/tools/playlist.ts` with live clip tools:

1. Add tool `trigger_live_clip`:
   - Schema:
     ```typescript
     track: z.number().int().min(1)
       .describe('Playlist track (1-indexed)'),
     block: z.number().int().min(0)
       .describe('Block number (0-indexed) to trigger'),
     ```
   - Description: "Trigger a live clip in Performance Mode. Track is 1-indexed, block is 0-indexed. Note: Performance Mode must be enabled in FL Studio for clips to play."
   - Execute `playlist.trigger_clip` with `{track, block}`

2. Add tool `stop_live_clips`:
   - Schema:
     ```typescript
     track: z.number().int().min(1)
       .describe('Playlist track (1-indexed) to stop clips on'),
     ```
   - Description: "Stop all live clips on a playlist track. Track is 1-indexed. Requires Performance Mode."
   - Execute `playlist.stop_clips` with `{track}`

3. Add tool `get_live_status`:
   - Schema:
     ```typescript
     track: z.number().int().min(1)
       .describe('Playlist track (1-indexed) to check status'),
     ```
   - Description: "Get live clip status for a playlist track. Track is 1-indexed. Returns status indicating if clips are playing/scheduled."
   - Execute `playlist.get_live_status` with `{track}`

All tools follow the exact error handling pattern from existing tools in the file.
  </action>
  <verify>
    - `npm run build` completes without TypeScript errors
    - File contains: `trigger_live_clip`
    - File contains: `stop_live_clips`
    - File contains: `get_live_status`
    - File contains: `playlist.trigger_clip`
    - File contains: `playlist.stop_clips`
    - File contains: `playlist.get_live_status`
    - File contains: `Performance Mode` (documentation)
  </verify>
  <done>
    MCP tools for live clip control registered:
    - trigger_live_clip: triggers clips in performance mode
    - stop_live_clips: stops clips on a track
    - get_live_status: queries playback status
    - All tools document Performance Mode requirement
  </done>
</task>

</tasks>

<verification>
1. TypeScript builds: `npm run build` passes
2. Python syntax: `python -m py_compile fl-bridge/handlers/playlist.py` passes
3. Handler registration: grep confirms 3 live clip handlers registered
4. MCP tools: grep confirms 3 live clip tools in playlist.ts
5. Performance Mode documentation: grep confirms warning in both files
</verification>

<success_criteria>
- [ ] `playlist.py` has 3 new live clip handlers (trigger, stop, status)
- [ ] `playlist.ts` has 3 new live clip tools
- [ ] Track validation uses 1-indexed bounds
- [ ] Block parameter accepts 0-indexed values
- [ ] Performance Mode requirement documented
- [ ] TypeScript builds successfully
</success_criteria>

<output>
After completion, create `.planning/phases/10-playlist-markers/10-03-SUMMARY.md`
</output>
