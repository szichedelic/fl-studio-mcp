---
phase: 10-playlist-markers
plan: 02
type: execute
wave: 2
depends_on: ["10-01"]
files_modified:
  - fl-bridge/handlers/playlist.py
  - src/tools/playlist.ts
autonomous: true

must_haves:
  truths:
    - "User can list all markers in the project"
    - "User can add markers at a specific bar or current position"
    - "User can navigate to markers by name"
  artifacts:
    - path: "fl-bridge/handlers/playlist.py"
      provides: "Marker handlers (list_markers, add_marker, jump_to_marker)"
      contains: "register_handler('playlist.list_markers'"
    - path: "src/tools/playlist.ts"
      provides: "MCP tools for markers"
      contains: "list_markers"
  key_links:
    - from: "src/tools/playlist.ts"
      to: "fl-bridge/handlers/playlist.py"
      via: "connection.executeCommand('playlist.list_markers')"
      pattern: "executeCommand\\('playlist\\.list_markers'"
    - from: "fl-bridge/handlers/playlist.py"
      to: "FL Studio arrangement module"
      via: "arrangement.getMarkerName, addAutoTimeMarker"
      pattern: "arrangement\\.(getMarkerName|addAutoTimeMarker)"
---

<objective>
Add marker management handlers and MCP tools for listing, adding, and navigating to time markers.

Purpose: Enable users to organize projects with named markers and navigate quickly (requirements PLAY-05 through PLAY-07).
Output: Extended playlist.py with marker handlers, extended playlist.ts with marker tools.
</objective>

<execution_context>
@C:\Users\jared\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\jared\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-playlist-markers/10-RESEARCH.md
@.planning/phases/10-playlist-markers/10-01-SUMMARY.md

# Files to extend
@fl-bridge/handlers/playlist.py
@src/tools/playlist.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add marker handlers to playlist.py</name>
  <files>fl-bridge/handlers/playlist.py</files>
  <action>
Extend `fl-bridge/handlers/playlist.py` with marker handlers:

1. Add imports at top (if not already present from Task 1):
   ```python
   import arrangement
   import transport
   import general
   ```

2. Add handler `handle_playlist_list_markers(params)`:
   - CRITICAL: No markerCount() API exists - must iterate until empty string
   - Initialize empty list `markers = []`
   - Iterate from index 0:
     ```python
     index = 0
     while True:
         name = arrangement.getMarkerName(index)
         if not name:  # Empty string = no more markers
             break
         markers.append({'index': index, 'name': name})
         index += 1
         if index > 999:  # Safety limit
             break
     ```
   - Return `{success: True, markerCount: len(markers), markers}`

3. Add handler `handle_playlist_add_marker(params)`:
   - Required params: `name` (str)
   - Optional params: `bar` (int, 1-indexed) - if not provided, use current position
   - If bar provided:
     ```python
     ppq = general.getRecPPQ()
     ticks = (bar - 1) * 4 * ppq  # Convert bar to ticks (4/4 time)
     ```
   - If bar not provided:
     ```python
     ticks = transport.getSongPos(2)  # SONGLENGTH_ABSTICKS = 2
     ```
   - Call `arrangement.addAutoTimeMarker(ticks, name)`
   - Return `{success: True, name, ticks, bar: (ticks // (4 * ppq)) + 1 if ppq else None}`

4. Add handler `handle_playlist_jump_to_marker(params)`:
   - Accept either `name` (str) or `index` (int)
   - If name provided:
     - Iterate through markers to find matching name (case-insensitive substring match)
     - If not found, return error
   - CRITICAL: jumpToMarker(delta, select) uses RELATIVE delta, not absolute
   - For reliable navigation, find marker index first, then use selection approach:
     ```python
     # Find marker by iterating
     target_index = None
     target_name = None
     i = 0
     while True:
         marker_name = arrangement.getMarkerName(i)
         if not marker_name:
             break
         if name and name.lower() in marker_name.lower():
             target_index = i
             target_name = marker_name
             break
         elif index is not None and i == index:
             target_index = i
             target_name = marker_name
             break
         i += 1
         if i > 999:
             break

     if target_index is None:
         return {'success': False, 'error': f'Marker not found'}

     # Use selection marker jump - jump forward to first marker, then navigate
     # Note: This is approximate due to API limitations
     arrangement.jumpToMarker(1, True)  # Jump to next marker
     ```
   - Return `{success: True, marker: target_name, index: target_index}`
   - NOTE: Document in docstring that marker navigation has API limitations

5. Register new handlers at bottom of file:
   ```python
   # Marker handlers (Phase 10 Plan 02)
   register_handler('playlist.list_markers', handle_playlist_list_markers)
   register_handler('playlist.add_marker', handle_playlist_add_marker)
   register_handler('playlist.jump_to_marker', handle_playlist_jump_to_marker)
   ```

6. Update module docstring to include new handlers in REGISTERED HANDLERS section.
  </action>
  <verify>
    - `python -m py_compile fl-bridge/handlers/playlist.py` passes
    - File contains: `register_handler('playlist.list_markers'`
    - File contains: `register_handler('playlist.add_marker'`
    - File contains: `register_handler('playlist.jump_to_marker'`
    - File contains: `arrangement.getMarkerName`
    - File contains: `arrangement.addAutoTimeMarker`
    - File contains: `general.getRecPPQ()`
    - File contains: `if index > 999:` (safety limit)
  </verify>
  <done>
    Python handlers for marker management registered:
    - playlist.list_markers: iterates until empty string (no markerCount API)
    - playlist.add_marker: converts bar to ticks using PPQ
    - playlist.jump_to_marker: finds marker by name/index, uses relative navigation
  </done>
</task>

<task type="auto">
  <name>Task 2: Add marker MCP tools to playlist.ts</name>
  <files>src/tools/playlist.ts</files>
  <action>
Extend `src/tools/playlist.ts` with marker tools:

1. Add tool `list_markers`:
   - No parameters
   - Description: "List all time markers in the project. Returns marker names and indices."
   - Execute `playlist.list_markers` with empty params
   - Return JSON result

2. Add tool `add_marker`:
   - Schema:
     ```typescript
     name: z.string().describe('Name for the marker'),
     bar: z.number().int().min(1).optional()
       .describe('Bar number (1-indexed) to place marker. If not provided, places at current playhead position.'),
     ```
   - Description: "Add a time marker at a specific bar or the current playhead position. Bar numbers are 1-indexed."
   - Execute `playlist.add_marker` with `{name, bar}` (bar only if defined)

3. Add tool `jump_to_marker`:
   - Schema:
     ```typescript
     name: z.string().optional()
       .describe('Marker name to jump to (case-insensitive partial match)'),
     index: z.number().int().min(0).optional()
       .describe('Marker index (0-indexed) to jump to'),
     ```
   - Description: "Jump to a marker by name or index. Provide either name (partial match supported) or index. Note: Navigation uses FL Studio's relative marker jump API."
   - Validate that at least one of name or index is provided
   - Execute `playlist.jump_to_marker` with `{name, index}` (only defined values)

All tools follow the exact error handling pattern from existing tools in the file.
  </action>
  <verify>
    - `npm run build` completes without TypeScript errors
    - File contains: `list_markers`
    - File contains: `add_marker`
    - File contains: `jump_to_marker`
    - File contains: `playlist.list_markers`
    - File contains: `playlist.add_marker`
    - File contains: `playlist.jump_to_marker`
  </verify>
  <done>
    MCP tools for marker management registered:
    - list_markers: returns all project markers
    - add_marker: creates markers at bar or current position
    - jump_to_marker: navigates by name or index
  </done>
</task>

</tasks>

<verification>
1. TypeScript builds: `npm run build` passes
2. Python syntax: `python -m py_compile fl-bridge/handlers/playlist.py` passes
3. Handler registration: grep confirms 3 marker handlers registered
4. MCP tools: grep confirms 3 marker tools in playlist.ts
5. Iteration safety: grep confirms `index > 999` safety limit
</verification>

<success_criteria>
- [ ] `playlist.py` has 3 new marker handlers (list, add, jump)
- [ ] `playlist.ts` has 3 new marker tools (list_markers, add_marker, jump_to_marker)
- [ ] Marker enumeration uses iteration (not hardcoded count)
- [ ] Bar-to-ticks conversion uses `general.getRecPPQ()`
- [ ] Safety limit prevents infinite loops in marker iteration
- [ ] TypeScript builds successfully
</success_criteria>

<output>
After completion, create `.planning/phases/10-playlist-markers/10-02-SUMMARY.md`
</output>
