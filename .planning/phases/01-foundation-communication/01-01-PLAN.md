---
phase: 01-foundation-communication
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - tsconfig.json
  - src/index.ts
  - src/bridge/sysex-codec.ts
  - src/bridge/midi-client.ts
  - src/bridge/connection.ts
  - src/bridge/types.ts
autonomous: true

must_haves:
  truths:
    - "MCP server starts without errors"
    - "Server can encode commands to SysEx format"
    - "Server can decode SysEx responses"
    - "MIDI ports can be opened for communication"
  artifacts:
    - path: "package.json"
      provides: "Project dependencies and scripts"
      contains: "@modelcontextprotocol/sdk"
    - path: "tsconfig.json"
      provides: "TypeScript configuration"
    - path: "src/index.ts"
      provides: "MCP server entry point"
      exports: ["server"]
    - path: "src/bridge/sysex-codec.ts"
      provides: "SysEx encoding/decoding"
      exports: ["SysExCodec"]
    - path: "src/bridge/midi-client.ts"
      provides: "MIDI port management"
      exports: ["MidiClient"]
  key_links:
    - from: "src/index.ts"
      to: "@modelcontextprotocol/sdk"
      via: "import McpServer, StdioServerTransport"
      pattern: "import.*McpServer.*from.*@modelcontextprotocol"
    - from: "src/bridge/midi-client.ts"
      to: "src/bridge/sysex-codec.ts"
      via: "uses codec for message encoding"
      pattern: "import.*SysExCodec"
---

<objective>
Set up MCP server scaffolding with TypeScript, install dependencies, and implement the communication bridge layer (SysEx codec + MIDI client) that will talk to FL Studio.

Purpose: This is the Node.js foundation. Without a working MCP server and MIDI communication layer, nothing else can function.

Output: A runnable MCP server that can encode/decode SysEx messages and manage MIDI port connections. No FL Studio tools yet - just the infrastructure.
</objective>

<execution_context>
@C:\Users\jared\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\jared\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-foundation-communication/01-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Initialize Node.js project with MCP SDK</name>
  <files>package.json, tsconfig.json, src/index.ts, src/bridge/types.ts</files>
  <action>
Create the Node.js project structure:

1. Initialize npm project with `npm init -y`

2. Install dependencies:
   - `npm install @modelcontextprotocol/sdk@^1.26.0 zod@^3.23.0 midi`
   - `npm install -D typescript@^5.5.0 @types/node tsx`

3. Create tsconfig.json:
   - target: ES2022
   - module: NodeNext
   - moduleResolution: NodeNext
   - outDir: dist
   - strict: true
   - esModuleInterop: true

4. Create src/bridge/types.ts with shared types:
   - FLCommand: { action: string, params: Record<string, unknown> }
   - FLResponse: { success: boolean, data?: unknown, error?: string }
   - ConnectionState: 'disconnected' | 'connecting' | 'connected'

5. Create src/index.ts:
   - Import McpServer from @modelcontextprotocol/sdk/server/mcp.js
   - Import StdioServerTransport from @modelcontextprotocol/sdk/server/stdio.js
   - Create server with name "fl-studio-mcp", version "1.0.0"
   - Connect with stdio transport
   - Add placeholder comment for tools (will add in Plan 03)

6. Add scripts to package.json:
   - "build": "tsc"
   - "start": "node dist/index.js"
   - "dev": "tsx src/index.ts"

Set "type": "module" in package.json for ES modules.
  </action>
  <verify>
Run `npm run build` - should compile without errors.
Run `npm run dev` - should start (will exit since no tools, but no crash).
  </verify>
  <done>
Project compiles. MCP server initializes without errors. package.json has all required dependencies.
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement SysEx codec and MIDI client</name>
  <files>src/bridge/sysex-codec.ts, src/bridge/midi-client.ts, src/bridge/connection.ts</files>
  <action>
1. Create src/bridge/sysex-codec.ts:
   - Class SysExCodec with static HEADER = [0xF0, 0x7D]
   - encode(command: FLCommand, clientId: number): number[]
     - JSON stringify command
     - Base64 encode the JSON string
     - Build SysEx message: HEADER + [0x00 (origin:client), clientId, 0x00 (no continuation), 0x01 (command), 0x00 (status:ok)] + base64 bytes + [0xF7]
   - decode(sysex: number[]): { clientId: number, data: FLResponse }
     - Validate starts with F0 7D and ends with F7
     - Extract clientId from byte 3
     - Extract payload bytes (skip 7 header bytes, exclude F7)
     - Base64 decode, JSON parse
     - Return { clientId, data }
   - Ensure all bytes are 7-bit safe (values 0-127 only)

2. Create src/bridge/midi-client.ts:
   - Import midi from 'midi'
   - Class MidiClient:
     - private input: midi.Input
     - private output: midi.Output
     - private codec: SysExCodec
     - private pendingRequests: Map<number, {resolve, reject, timeout}>
     - private nextClientId = 1
     - constructor() - create input/output instances
     - connect(inputPortName: string, outputPortName: string): boolean
       - Find ports by name (partial match)
       - Enable SysEx on input: input.ignoreTypes(false, false, false)
       - Open ports, set up message handler
       - Return true if both ports opened
     - listPorts(): { inputs: string[], outputs: string[] }
       - Return available port names for debugging
     - sendCommand(action: string, params: object): Promise<FLResponse>
       - Generate clientId (wrap at 0x7F)
       - Create promise with timeout (5000ms)
       - Store in pendingRequests
       - Encode and send via output.sendMessage()
     - private handleMessage(deltaTime: number, message: number[])
       - If message[0] === 0xF0, decode and resolve pending request
     - disconnect()
       - Close ports, clear pending requests

3. Create src/bridge/connection.ts:
   - Export class ConnectionManager:
     - private client: MidiClient
     - private state: ConnectionState = 'disconnected'
     - connect(inputPort: string, outputPort: string): Promise<boolean>
     - getState(): ConnectionState
     - executeCommand(action: string, params: object): Promise<FLResponse>
       - Throw if not connected
       - Delegate to client.sendCommand
     - disconnect()

Export all classes for use by tools.
  </action>
  <verify>
Run `npm run build` - should compile without type errors.
Check that midi package is importable: `node -e "require('midi')"`
  </verify>
  <done>
SysExCodec can encode/decode messages. MidiClient can list available MIDI ports. ConnectionManager provides clean async interface. All TypeScript compiles cleanly.
  </done>
</task>

</tasks>

<verification>
- [ ] `npm run build` compiles without errors
- [ ] `npm run dev` starts MCP server (may exit quickly, but no crash)
- [ ] src/bridge/sysex-codec.ts exports SysExCodec class
- [ ] src/bridge/midi-client.ts exports MidiClient class
- [ ] src/bridge/connection.ts exports ConnectionManager class
- [ ] All imports resolve correctly
</verification>

<success_criteria>
1. Project structure exists with all dependencies installed
2. TypeScript compiles without errors
3. MCP server can be instantiated
4. SysEx codec correctly encodes/decodes test messages
5. MIDI client can list available ports (even if none exist yet)
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-communication/01-01-SUMMARY.md`
</output>
