---
phase: 08-mixer-core
plan: 02
type: execute
wave: 2
depends_on: ["08-01"]
files_modified:
  - src/tools/mixer.ts
  - src/tools/index.ts
autonomous: true

must_haves:
  truths:
    - "User can call set_mixer_volume tool with track and volume params"
    - "User can call set_mixer_pan tool with track and pan params"
    - "User can call mute_mixer_track tool with track and mute boolean"
    - "User can call solo_mixer_track tool with track and solo boolean"
    - "User can call set_mixer_track_name tool with track and name"
    - "User can call set_mixer_track_color tool with track and color (RGB)"
    - "Tool responses show success and readback values"
  artifacts:
    - path: "src/tools/mixer.ts"
      provides: "MCP tools for mixer control"
      exports: ["registerMixerTools"]
      min_lines: 80
    - path: "src/tools/index.ts"
      provides: "Tool registration entry point"
      contains: "registerMixerTools"
  key_links:
    - from: "src/tools/mixer.ts"
      to: "FL Bridge"
      via: "connection.executeCommand"
      pattern: "executeCommand\\('mixer\\."
    - from: "src/tools/index.ts"
      to: "src/tools/mixer.ts"
      via: "import and call"
      pattern: "registerMixerTools\\(server, connection\\)"
---

<objective>
Create MCP tools for mixer track control, wrapping the FL Bridge handlers.

Purpose: Expose mixer mutations (volume, pan, mute, solo, name, color) as MCP tools that Claude can invoke via natural language commands.

Output: New `mixer.ts` module with 6 tools, updated `index.ts` to register them.
</objective>

<execution_context>
@C:\Users\jared\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\jared\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-mixer-core/08-RESEARCH.md
@.planning/phases/08-mixer-core/08-01-SUMMARY.md

# Existing patterns to follow
@src/tools/plugins.ts
@src/tools/state.ts
@src/tools/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create mixer.ts with MCP tools</name>
  <files>src/tools/mixer.ts</files>
  <action>
Create new tool module following the pattern from `plugins.ts`. Include these tools:

**1. set_mixer_volume**
- Description: "Set a mixer track's volume level (0.0-1.0, where 0.8 = unity/0dB)"
- Params:
  - `track`: z.number().int().min(0).describe('Mixer track index (0=Master, 1+=insert tracks)')
  - `volume`: z.number().min(0).max(1).describe('Volume level (0.0-1.0, where 0.8 = 0dB unity gain)')
- Call: `connection.executeCommand('mixer.set_volume', { index: track, volume })`
- Return: JSON.stringify result

**2. set_mixer_pan**
- Description: "Set a mixer track's pan position (-1.0=left, 0=center, 1.0=right)"
- Params:
  - `track`: z.number().int().min(0).describe('Mixer track index (0=Master, 1+=insert tracks)')
  - `pan`: z.number().min(-1).max(1).describe('Pan position (-1.0=hard left, 0=center, 1.0=hard right)')
- Call: `connection.executeCommand('mixer.set_pan', { index: track, pan })`
- Return: JSON.stringify result

**3. mute_mixer_track**
- Description: "Mute or unmute a mixer track"
- Params:
  - `track`: z.number().int().min(0).describe('Mixer track index (0=Master, 1+=insert tracks)')
  - `mute`: z.boolean().describe('True to mute, false to unmute')
- Call: `connection.executeCommand('mixer.mute', { index: track, mute })`
- Return: JSON.stringify result

**4. solo_mixer_track**
- Description: "Solo or unsolo a mixer track"
- Params:
  - `track`: z.number().int().min(0).describe('Mixer track index (0=Master, 1+=insert tracks)')
  - `solo`: z.boolean().describe('True to solo, false to unsolo')
- Call: `connection.executeCommand('mixer.solo', { index: track, solo })`
- Return: JSON.stringify result

**5. set_mixer_track_name**
- Description: "Set a mixer track's display name"
- Params:
  - `track`: z.number().int().min(0).describe('Mixer track index (0=Master, 1+=insert tracks)')
  - `name`: z.string().describe('New track name (empty string resets to default)')
- Call: `connection.executeCommand('mixer.set_name', { index: track, name })`
- Return: JSON.stringify result

**6. set_mixer_track_color**
- Description: "Set a mixer track's color (accepts RGB hex like '#FF0000' for red)"
- Params:
  - `track`: z.number().int().min(0).describe('Mixer track index (0=Master, 1+=insert tracks)')
  - `color`: z.string().describe('Color as RGB hex string (e.g., "#FF0000" for red, "#00FF00" for green)')
- **Important:** Convert RGB to BGR before sending! FL Studio uses BGR format.
- Parse hex string, extract R/G/B, compute BGR: `(b << 16) | (g << 8) | r`
- Call: `connection.executeCommand('mixer.set_color', { index: track, color: bgrValue })`
- Return: JSON.stringify result

**Module structure:**
```typescript
/**
 * Mixer Control Tools for FL Studio MCP
 *
 * Provides MCP tools for controlling mixer tracks:
 * - set_mixer_volume: Set track volume (0.0-1.0, 0.8 = 0dB)
 * - set_mixer_pan: Set track pan (-1.0 to 1.0)
 * - mute_mixer_track: Mute/unmute track
 * - solo_mixer_track: Solo/unsolo track
 * - set_mixer_track_name: Rename track
 * - set_mixer_track_color: Set track color (RGB hex input, converted to BGR)
 */

import type { McpServer } from '@modelcontextprotocol/sdk/server/mcp.js';
import type { ConnectionManager } from '../bridge/connection.js';
import { z } from 'zod';

/**
 * Convert RGB hex string (#RRGGBB) to FL Studio BGR integer.
 */
function rgbHexToBgr(hex: string): number {
  const clean = hex.replace('#', '');
  const r = parseInt(clean.substring(0, 2), 16);
  const g = parseInt(clean.substring(2, 4), 16);
  const b = parseInt(clean.substring(4, 6), 16);
  return (b << 16) | (g << 8) | r;
}

export function registerMixerTools(
  server: McpServer,
  connection: ConnectionManager
): void {
  // ... tool registrations ...
}
```

**Critical notes:**
- Tool descriptions should mention 0.8 = 0dB for volume (per research)
- Track 0 is Master, 1+ are inserts - document in descriptions
- RGB-to-BGR conversion is REQUIRED for color tool
  </action>
  <verify>
Read the created file and confirm:
1. All 6 tools are registered
2. `rgbHexToBgr` helper function exists and is used by color tool
3. Volume tool description mentions 0.8 = 0dB
4. Pan tool description mentions -1.0 to 1.0 range
5. Export is `registerMixerTools`
  </verify>
  <done>
`mixer.ts` contains 6 MCP tools with proper validation, RGB-to-BGR conversion, and clear descriptions.
  </done>
</task>

<task type="auto">
  <name>Task 2: Register mixer tools in index.ts</name>
  <files>src/tools/index.ts</files>
  <action>
Add import and registration for the new mixer tools module:

1. Add import at top with other tool imports:
```typescript
import { registerMixerTools } from './mixer.js';
```

2. Add registration call in `registerTools()` function:
```typescript
registerMixerTools(server, connection);
```

3. Update the console.error log to include 'mixer' in the tool list.

Follow the existing pattern from other tool registrations (plugins, serum, sample, etc.).
  </action>
  <verify>
Read the file and confirm:
1. `import { registerMixerTools } from './mixer.js';` is present
2. `registerMixerTools(server, connection);` is called in registerTools()
3. Console log includes 'mixer' in the list
  </verify>
  <done>
`index.ts` imports and registers mixer tools, making them available to MCP clients.
  </done>
</task>

<task type="auto">
  <name>Task 3: Build and verify TypeScript compiles</name>
  <files></files>
  <action>
Run the TypeScript build to ensure no compilation errors:

```bash
cd C:\Users\jared\Documents\GitHub\fl-studio-mcp
npm run build
```

If build fails, fix any type errors in the new mixer.ts file.

Common issues to watch for:
- Missing `.js` extension in imports
- Type mismatches with ConnectionManager.executeCommand
- Zod schema type inference issues
  </action>
  <verify>
Build command exits with code 0 and no errors in output.
  </verify>
  <done>
TypeScript compiles successfully, MCP server is ready to run with new mixer tools.
  </done>
</task>

</tasks>

<verification>
After all tasks complete:

1. **Build verification:**
   - `npm run build` succeeds
   - No TypeScript errors

2. **Tool presence:**
   - mixer.ts exports registerMixerTools
   - index.ts imports and calls it
   - 6 tools are defined

3. **Integration test (manual, after FL Bridge sync):**
   - Start MCP server
   - Connect to FL Studio
   - Test: `set_mixer_volume` with track=1, volume=0.5
   - Verify: FL Studio mixer track 1 volume changes
</verification>

<success_criteria>
- [ ] `mixer.ts` exists with 6 tool registrations
- [ ] `rgbHexToBgr` helper correctly converts RGB hex to BGR int
- [ ] Tool descriptions document 0.8 = 0dB, track 0 = Master
- [ ] `index.ts` imports and registers mixer tools
- [ ] `npm run build` succeeds with no errors
- [ ] Console log updated to include 'mixer'
</success_criteria>

<output>
After completion, create `.planning/phases/08-mixer-core/08-02-SUMMARY.md`
</output>
