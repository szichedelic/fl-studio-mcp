---
phase: 09-mixer-routing-advanced
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/tools/mixer.ts
  - src/tools/index.ts
autonomous: true

must_haves:
  truths:
    - "Tool get_mixer_routing returns full routing table from FL Studio"
    - "Tool get_track_sends returns sends for a track (by index or name)"
    - "Tool create_send creates a route with optional initial level"
    - "Tool remove_send removes a route between tracks"
    - "Tool set_send_level sets level for existing route"
    - "Tool get_mixer_eq returns all 3 EQ bands with dB and Hz values"
    - "Tool set_mixer_eq_band sets EQ parameters (gain, frequency, bandwidth)"
    - "Tool discover_mixer_effect discovers plugin in mixer track slot"
    - "Tool get_mixer_effect_param gets effect parameter by name"
    - "Tool set_mixer_effect_param sets effect parameter by name"
  artifacts:
    - path: "src/tools/mixer.ts"
      provides: "Routing, EQ, and effect slot MCP tools"
      contains: "get_mixer_routing"
      contains: "get_mixer_eq"
      contains: "discover_mixer_effect"
  key_links:
    - from: "src/tools/mixer.ts"
      to: "mixer.get_routing"
      via: "connection.executeCommand"
      pattern: "executeCommand.*mixer\\.get_routing"
    - from: "src/tools/mixer.ts"
      to: "plugins.discover"
      via: "connection.executeCommand with slotIndex"
      pattern: "executeCommand.*plugins\\.discover"
---

<objective>
Add MCP tools for mixer routing, EQ control, and effect slot access to the existing mixer.ts.

Purpose: Exposes mixer routing and EQ functionality to Claude via MCP tools, plus convenience wrappers for accessing effects in mixer slots.

Output: Extended mixer.ts with 10 new tools (5 routing, 2 EQ, 3 effect slot convenience wrappers).
</objective>

<execution_context>
@C:\Users\jared\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\jared\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-mixer-routing-advanced/09-RESEARCH.md
@src/tools/mixer.ts
@src/tools/plugins.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add routing tools (get_mixer_routing, get_track_sends, create_send, remove_send, set_send_level)</name>
  <files>src/tools/mixer.ts</files>
  <action>
Add 5 routing tools to mixer.ts following the established patterns (Zod schema, try/catch, JSON.stringify result):

1. `get_mixer_routing` - Get full routing table
   - Schema: no required params
   - Calls `mixer.get_routing`
   - Returns JSON with all active routes

2. `get_track_sends` - Get sends for a specific track
   - Schema: `track` (number, mixer track index)
   - Calls `mixer.get_track_sends` with `{index: track}`
   - Returns sends for that track

3. `create_send` - Create a send route
   - Schema:
     - `source` (number, required) - source mixer track
     - `destination` (number, required) - destination mixer track
     - `level` (number, optional, 0-1, default 0.8) - initial send level (0.8 = unity)
   - Calls `mixer.set_route` with `{source, destination, enabled: true}`
   - If level provided AND not 0.8, also calls `mixer.set_route_level` to set level
   - Returns combined result

4. `remove_send` - Remove a send route
   - Schema:
     - `source` (number, required)
     - `destination` (number, required)
   - Calls `mixer.set_route` with `{source, destination, enabled: false}`
   - Returns result

5. `set_send_level` - Set send level for existing route
   - Schema:
     - `source` (number, required)
     - `destination` (number, required)
     - `level` (number, required, 0-1) - send level (0.8 = unity/0dB)
   - Calls `mixer.set_route_level` with `{source, destination, level}`
   - Returns result

Tool descriptions should mention:
- Track index 0 = Master, 1+ = insert tracks
- Level 0.8 = unity gain (0dB), same as mixer volume

Add these after the existing color tool (end of registerMixerTools function).
  </action>
  <verify>Read mixer.ts and confirm all 5 routing tool registrations exist with proper schemas and descriptions.</verify>
  <done>Five routing tools implemented with proper Zod schemas, descriptions, and error handling.</done>
</task>

<task type="auto">
  <name>Task 2: Add EQ tools (get_mixer_eq, set_mixer_eq_band)</name>
  <files>src/tools/mixer.ts</files>
  <action>
Add 2 EQ tools to mixer.ts:

1. `get_mixer_eq` - Get track EQ settings
   - Schema: `track` (number, required) - mixer track index
   - Calls `mixer.get_eq` with `{index: track}`
   - Returns all 3 bands with gain (normalized + dB), frequency (normalized + Hz), bandwidth

2. `set_mixer_eq_band` - Set EQ band parameters
   - Schema:
     - `track` (number, required) - mixer track index
     - `band` (number, required, 0-2) - band index (0=Low, 1=Mid, 2=High)
     - `gain` (number, optional, 0-1) - normalized gain
     - `frequency` (number, optional, 0-1) - normalized frequency
     - `bandwidth` (number, optional, 0-1) - normalized bandwidth
   - At least one of gain/frequency/bandwidth should be provided
   - Calls `mixer.set_eq_band` with `{index: track, band, gain?, frequency?, bandwidth?}`
   - Returns updated band settings

Tool descriptions:
- Mention band names: 0=Low, 1=Mid, 2=High
- Values are normalized 0-1, response includes dB and Hz equivalents
- Default EQ has no effect (0.5 gain = 0dB, frequencies at neutral points)
  </action>
  <verify>Read mixer.ts and confirm both EQ tool registrations exist with band descriptions and optional parameter handling.</verify>
  <done>Two EQ tools implemented with band index validation and optional parameter support.</done>
</task>

<task type="auto">
  <name>Task 3: Add effect slot convenience tools (discover_mixer_effect, get_mixer_effect_param, set_mixer_effect_param)</name>
  <files>src/tools/mixer.ts</files>
  <action>
Add 3 effect slot convenience tools that wrap the existing plugin system. These provide a mixer-focused interface without requiring users to understand the slotIndex convention.

1. `discover_mixer_effect` - Discover a plugin in a mixer track's effect slot
   - Schema:
     - `track` (number, required) - mixer track index (0=Master, 1+=inserts)
     - `slot` (number, required, 0-9) - effect slot index
   - Calls `plugins.discover` with `{index: track, slotIndex: slot}`
   - Returns plugin name and parameters

2. `get_mixer_effect_param` - Get an effect parameter by name
   - Schema:
     - `track` (number, required)
     - `slot` (number, required, 0-9)
     - `name` (string, required) - parameter name (fuzzy matched)
   - Calls `plugins.get_param` with `{index: track, slotIndex: slot, name}`
   - Wait, the plugins.get_param tool expects paramIndex, not name...

   Actually, looking at plugins.ts, the MCP tools handle name resolution via paramCache. But these are MCP tools calling handlers directly. We need to:
   - Either use the existing plugin tools' logic (but they're tools, not functions)
   - Or call the handlers directly with paramIndex

   SIMPLER APPROACH: These convenience tools should just document that users should use the EXISTING plugin tools (`discover_plugin_params`, `get_plugin_param`, `set_plugin_param`) with the `slotIndex` parameter. But that's not user-friendly.

   BETTER APPROACH: Create thin wrappers that re-use the existing plugin tool logic. Import the paramCache and shadowState, and replicate the resolution logic.

   Let's be pragmatic: Create these tools to call the handlers directly after resolving names:
   - For get: resolve name via paramCache, then call `plugins.get_param` handler
   - For set: resolve name via paramCache, then call `plugins.set_param` handler

   Import from plugins.ts module: We can't import the tools, but we can import the helpers (paramCache, shadowState).

Add these imports at top of mixer.ts:
```typescript
import { paramCache } from '../plugins/param-cache.js';
import { shadowState } from '../plugins/shadow-state.js';
```

For discover_mixer_effect:
   - Calls `plugins.discover` with `{index: track, slotIndex: slot}`
   - Stores in paramCache (like existing plugin tools do)
   - Returns plugin name and parameter count

For get_mixer_effect_param:
   - First check paramCache for track+slot
   - If not cached, call `plugins.discover` to populate
   - Resolve name via `paramCache.resolveParam(track, slot, name)`
   - Call `plugins.get_param` with resolved paramIndex
   - Return value

For set_mixer_effect_param:
   - Same resolution flow as get
   - Call `plugins.set_param` with resolved paramIndex
   - Update shadowState
   - Return result

This mirrors the existing plugin tools but with mixer-friendly parameter names (track+slot instead of channelIndex+slotIndex).
  </action>
  <verify>Read mixer.ts and confirm all 3 effect slot tools exist with proper imports and parameter resolution logic.</verify>
  <done>Three effect slot convenience tools implemented, reusing paramCache and shadowState from the plugin system.</done>
</task>

<task type="auto">
  <name>Task 4: Build and verify TypeScript compiles</name>
  <files>src/tools/mixer.ts, src/tools/index.ts</files>
  <action>
1. Run `npm run build` from the project root
2. Verify no TypeScript errors
3. Check that the build output includes the updated mixer tools

If there are import errors for paramCache or shadowState:
- Verify the import paths are correct: `../plugins/param-cache.js` and `../plugins/shadow-state.js`
- Check that the exports exist in those modules

If there are type errors:
- Add proper type annotations for the plugin discover/get/set response shapes
- Use `as unknown as Type` pattern if needed (following existing plugins.ts patterns)
  </action>
  <verify>
Run: `npm run build` - should complete with no errors
Run: `ls -la dist/tools/mixer.js` - should exist and be recently modified
  </verify>
  <done>TypeScript compiles successfully with all new tools included in build output.</done>
</task>

</tasks>

<verification>
After all tasks:
1. `grep -c "server.tool" src/tools/mixer.ts` should return 16 (6 original + 5 routing + 2 EQ + 3 effect slot)
2. `npm run build` succeeds with no errors
3. All tools have proper Zod schemas and descriptions
4. Effect slot tools properly integrate with paramCache/shadowState
</verification>

<success_criteria>
- mixer.ts has 16 registered tools (6 Phase 8 + 10 Phase 9)
- Routing tools: get_mixer_routing, get_track_sends, create_send, remove_send, set_send_level
- EQ tools: get_mixer_eq, set_mixer_eq_band
- Effect slot tools: discover_mixer_effect, get_mixer_effect_param, set_mixer_effect_param
- TypeScript build succeeds
- Effect slot tools reuse existing plugin infrastructure (paramCache, shadowState)
</success_criteria>

<output>
After completion, create `.planning/phases/09-mixer-routing-advanced/09-02-SUMMARY.md`
</output>
