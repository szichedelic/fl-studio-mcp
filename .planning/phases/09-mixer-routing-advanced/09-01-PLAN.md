---
phase: 09-mixer-routing-advanced
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - fl-bridge/handlers/mixer.py
autonomous: true

must_haves:
  truths:
    - "Handler mixer.get_routing returns all active routes with source, destination, and level"
    - "Handler mixer.get_track_sends returns sends for a specific track"
    - "Handler mixer.set_route can create and remove routes with UI update"
    - "Handler mixer.set_route_level sets send levels, validates route exists first"
    - "Handler mixer.get_eq returns all 3 EQ bands with normalized and real units"
    - "Handler mixer.set_eq_band sets gain, frequency, and bandwidth parameters"
  artifacts:
    - path: "fl-bridge/handlers/mixer.py"
      provides: "Routing and EQ handlers"
      contains: "handle_mixer_get_routing"
      contains: "handle_mixer_get_eq"
  key_links:
    - from: "fl-bridge/handlers/mixer.py"
      to: "mixer.setRouteTo"
      via: "FL Studio API call"
      pattern: "mixer\\.setRouteTo"
    - from: "fl-bridge/handlers/mixer.py"
      to: "mixer.setEqGain"
      via: "FL Studio API call"
      pattern: "mixer\\.setEq"
---

<objective>
Add Python handlers for mixer routing (sends) and EQ band control to the existing mixer.py.

Purpose: Enables FL Studio mixer routing queries and mutations, plus per-track EQ control, via the FL Bridge protocol.

Output: Extended mixer.py with 6 new handlers for routing and EQ operations.
</objective>

<execution_context>
@C:\Users\jared\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\jared\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-mixer-routing-advanced/09-RESEARCH.md
@fl-bridge/handlers/mixer.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add routing handlers (get_routing, get_track_sends, set_route, set_route_level)</name>
  <files>fl-bridge/handlers/mixer.py</files>
  <action>
Add 4 routing handlers to mixer.py following the established patterns (validation, try/except, readback):

1. `handle_mixer_get_routing(params)` - Get full routing table
   - No required params
   - Loop through all tracks, check `mixer.getRouteSendActive(src, dest)` for each pair
   - Return `{success, trackCount, routes: [{source, sourceName, destination, destName, level}]}`
   - Use existing `mixer.trackCount()` (or `getTrackCount()`)

2. `handle_mixer_get_track_sends(params)` - Get sends for one track
   - Required: `index` (int)
   - Validate index with `_validate_track_index()`
   - Loop destinations, check `getRouteSendActive(index, dest)`
   - Return `{success, track, trackName, sends: [{destination, destName, level}]}`

3. `handle_mixer_set_route(params)` - Create or remove a route
   - Required: `source` (int), `destination` (int), `enabled` (bool)
   - Validate both indices
   - Call `mixer.setRouteTo(source, destination, 1 if enabled else 0, True)` - True for UI update
   - Readback with `getRouteSendActive()`
   - Return `{success, source, destination, active}`

4. `handle_mixer_set_route_level(params)` - Set send level for existing route
   - Required: `source` (int), `destination` (int), `level` (float 0.0-1.0)
   - Validate indices
   - CRITICAL: First check `getRouteSendActive()` - if route doesn't exist, return error
   - Call `mixer.setRouteToLevel(source, destination, level)`
   - Readback level
   - Return `{success, source, destination, level}`
   - Note: 0.8 = unity gain (0dB), same as mixer volume

Register all handlers at bottom of file:
```python
register_handler('mixer.get_routing', handle_mixer_get_routing)
register_handler('mixer.get_track_sends', handle_mixer_get_track_sends)
register_handler('mixer.set_route', handle_mixer_set_route)
register_handler('mixer.set_route_level', handle_mixer_set_route_level)
```

IMPORTANT: The full routing table scan (get_routing) iterates trackCount^2 pairs. This is O(n^2) but necessary. FL Studio has ~127 mixer tracks by default, so ~16K checks. Keep it simple, no premature optimization.
  </action>
  <verify>Read mixer.py and confirm all 4 handler functions exist with proper validation and register_handler calls.</verify>
  <done>Four routing handlers implemented with validation, error handling, and readback patterns matching Phase 8 style.</done>
</task>

<task type="auto">
  <name>Task 2: Add EQ handlers (get_eq, set_eq_band)</name>
  <files>fl-bridge/handlers/mixer.py</files>
  <action>
Add 2 EQ handlers to mixer.py:

1. `handle_mixer_get_eq(params)` - Get all EQ band settings for a track
   - Required: `index` (int)
   - Validate index
   - Use `mixer.getEqBandCount()` to get band count (typically 3)
   - For each band, collect:
     - `gain` = `mixer.getEqGain(index, band)` (normalized 0-1)
     - `gainDb` = `mixer.getEqGain(index, band, 1)` (dB)
     - `frequency` = `mixer.getEqFrequency(index, band)` (normalized 0-1)
     - `frequencyHz` = `mixer.getEqFrequency(index, band, 1)` (Hz)
     - `bandwidth` = `mixer.getEqBandwidth(index, band)` (normalized 0-1)
   - Return `{success, track, trackName, bands: [{band, name, gain, gainDb, frequency, frequencyHz, bandwidth}]}`
   - Band names: 0='Low', 1='Mid', 2='High'

2. `handle_mixer_set_eq_band(params)` - Set EQ band parameters
   - Required: `index` (int), `band` (int 0-2)
   - Optional: `gain` (float 0-1), `frequency` (float 0-1), `bandwidth` (float 0-1)
   - Validate index and band (0 to getEqBandCount()-1)
   - Only set parameters that are provided:
     - If gain: `mixer.setEqGain(index, band, gain)`
     - If frequency: `mixer.setEqFrequency(index, band, frequency)`
     - If bandwidth: `mixer.setEqBandwidth(index, band, bandwidth)`
   - Readback all values for response
   - Return `{success, track, band, bandName, gain, gainDb, frequency, frequencyHz, bandwidth}`

Add a helper constant at top of handler section:
```python
EQ_BAND_NAMES = {0: 'Low', 1: 'Mid', 2: 'High'}
```

Register handlers:
```python
register_handler('mixer.get_eq', handle_mixer_get_eq)
register_handler('mixer.set_eq_band', handle_mixer_set_eq_band)
```
  </action>
  <verify>Read mixer.py and confirm both EQ handler functions exist with band name mapping, parameter validation, and register_handler calls.</verify>
  <done>Two EQ handlers implemented with normalized and real-unit readback, optional parameter updates, and proper band validation.</done>
</task>

<task type="auto">
  <name>Task 3: Update module docstring and sync to runtime location</name>
  <files>fl-bridge/handlers/mixer.py</files>
  <action>
1. Update the module docstring at the top of mixer.py to list all registered handlers:

```python
"""
FL Bridge Mixer Handlers

Handles mixer track mutations and queries: volume, pan, mute, solo, name, color,
routing, and EQ control.

REGISTERED HANDLERS:
====================
- mixer.set_volume: Set mixer track volume (0.0-1.0, where 0.8 = 0dB)
- mixer.set_pan: Set mixer track pan (-1.0 to 1.0)
- mixer.mute: Mute/unmute mixer track (explicit, not toggle)
- mixer.solo: Solo/unsolo mixer track (explicit, not toggle)
- mixer.set_name: Set mixer track name
- mixer.set_color: Set mixer track color (BGR format)
- mixer.get_routing: Get full routing table (all sends)
- mixer.get_track_sends: Get sends for a specific track
- mixer.set_route: Create or remove a route between tracks
- mixer.set_route_level: Set send level for existing route
- mixer.get_eq: Get track EQ band settings (all 3 bands)
- mixer.set_eq_band: Set EQ band parameters (gain, frequency, bandwidth)

IMPORTANT NOTES:
================
- Volume/send levels: 0.8 = unity gain (0dB), not 1.0
- Color format is BGR (0x--BBGGRR), not RGB
- Mute/solo use explicit 1/0, NOT -1 (toggle mode)
- Index 0 = Master track, 1+ = insert tracks
- EQ bands: 0=Low, 1=Mid, 2=High (values are normalized 0-1)
- Routes must exist before setting level (use set_route first)

AUTHOR: FL Studio MCP Project
"""
```

2. Copy the updated mixer.py to the FL Studio runtime location:

Destination: `C:/Users/jared/Documents/Image-Line/FL Studio/Settings/Hardware/FLBridge/handlers/mixer.py`

Note: This is the runtime location where FL Studio loads scripts from. The git repo copy is the source of truth, but FL Studio reads from the Documents folder.
  </action>
  <verify>
Run: `diff fl-bridge/handlers/mixer.py "C:/Users/jared/Documents/Image-Line/FL Studio/Settings/Hardware/FLBridge/handlers/mixer.py"` (should show no differences after copy)
  </verify>
  <done>Module docstring updated with all 12 handlers listed, and runtime copy synced.</done>
</task>

</tasks>

<verification>
After all tasks:
1. `grep -c "register_handler.*mixer\." fl-bridge/handlers/mixer.py` should return 12 (6 original + 6 new)
2. All handlers follow the pattern: validate params, try/except, readback value, return dict with success key
3. Runtime copy matches git repo copy
</verification>

<success_criteria>
- mixer.py has 12 registered handlers (6 Phase 8 + 6 Phase 9)
- Routing handlers: get_routing, get_track_sends, set_route, set_route_level
- EQ handlers: get_eq, set_eq_band
- All handlers validate track indices and return success/error dicts
- Runtime location synced with git repo
</success_criteria>

<output>
After completion, create `.planning/phases/09-mixer-routing-advanced/09-01-SUMMARY.md`
</output>
