---
phase: 05-serum-2-sound-design
plan: 03
type: execute
wave: 3
depends_on: ["05-01", "05-02"]
files_modified:
  - src/tools/serum.ts
  - src/tools/index.ts
autonomous: true

must_haves:
  truths:
    - "User can control Serum 2 oscillators, filters, macros, and FX using semantic names via serum_set_param tool"
    - "User can say 'create a warm pad' via serum_apply_recipe and get a multi-parameter configuration applied"
    - "User can browse Serum 2 presets by category and name via serum_browse_presets tool"
    - "User can navigate presets with serum_next_preset and serum_prev_preset tools"
    - "User can list available recipes with serum_list_recipes tool"
  artifacts:
    - path: "src/tools/serum.ts"
      provides: "Serum 2 MCP tools: serum_set_param, serum_apply_recipe, serum_browse_presets, serum_next_preset, serum_prev_preset, serum_list_recipes"
      exports: ["registerSerumTools"]
      min_lines: 100
    - path: "src/tools/index.ts"
      provides: "Registers Serum tools alongside existing tools"
      contains: "registerSerumTools"
  key_links:
    - from: "src/tools/serum.ts"
      to: "src/plugins/serum/aliases.ts"
      via: "resolveSemanticAlias called before Phase 4 set_plugin_param"
      pattern: "resolveSemanticAlias"
    - from: "src/tools/serum.ts"
      to: "src/plugins/serum/recipes.ts"
      via: "findRecipes used by serum_apply_recipe tool"
      pattern: "findRecipes"
    - from: "src/tools/serum.ts"
      to: "src/plugins/serum/presets.ts"
      via: "listSerumPresets used by serum_browse_presets tool"
      pattern: "listSerumPresets"
    - from: "src/tools/serum.ts"
      to: "src/bridge/connection.ts"
      via: "executeCommand for preset navigation and parameter setting"
      pattern: "connection\\.executeCommand"
    - from: "src/tools/index.ts"
      to: "src/tools/serum.ts"
      via: "import and call registerSerumTools"
      pattern: "registerSerumTools"
---

<objective>
Wire all Serum 2 modules into MCP tools and register them in the tool index, completing the Phase 5 user-facing surface.

Purpose: This is the final integration plan -- it connects the alias map, recipes, preset browsing, and FL Bridge preset handlers into MCP tools that Claude can call. After this plan, users can control Serum 2 parameters with natural language, apply sound recipes, and browse presets.

Output: `src/tools/serum.ts` with 6 Serum 2 MCP tools, and updated `src/tools/index.ts` with registration.
</objective>

<execution_context>
@C:\Users\jared\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\jared\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-serum-2-sound-design/05-01-SUMMARY.md
@.planning/phases/05-serum-2-sound-design/05-02-SUMMARY.md
@src/plugins/serum/types.ts
@src/plugins/serum/aliases.ts
@src/plugins/serum/recipes.ts
@src/plugins/serum/presets.ts
@src/tools/plugins.ts
@src/tools/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Serum 2 MCP tools</name>
  <files>src/tools/serum.ts</files>
  <action>
    Create `src/tools/serum.ts` exporting a `registerSerumTools(server, connection)` function following the exact same pattern as `registerPluginTools` in `src/tools/plugins.ts`.

    Import dependencies:
    ```typescript
    import type { McpServer } from '@modelcontextprotocol/sdk/server/mcp.js';
    import type { ConnectionManager } from '../bridge/connection.js';
    import { z } from 'zod';
    import { paramCache } from '../plugins/param-cache.js';
    import { shadowState } from '../plugins/shadow-state.js';
    import { resolveSemanticAlias, SERUM_ALIASES, getAliasGroups } from '../plugins/serum/aliases.js';
    import { RECIPES, findRecipes, listRecipeNames } from '../plugins/serum/recipes.js';
    import { listSerumPresets, getSerumPresetDir } from '../plugins/serum/presets.js';
    import type { DiscoveredParam } from '../plugins/types.js';
    ```

    Re-use the autoDiscover and formatAvailableParams helpers. Either import them from plugins.ts (if exported) or duplicate the same logic locally. Check if plugins.ts exports them -- if not, copy the autoDiscover function locally (it calls connection.executeCommand('plugins.discover', ...) and stores in paramCache + shadowState).

    **Tool 1: serum_set_param**
    - Description: "Set a Serum 2 parameter using musical language. Supports names like 'filter cutoff', 'osc a level', 'macro 1'. Fuzzy matched through semantic aliases."
    - Schema: { name: z.string(), value: z.number().min(0).max(1), channelIndex: z.number().int().min(0).optional() }
    - Logic:
      1. Call resolveSemanticAlias(name) to translate semantic name to actual param name
      2. Try paramCache.resolveParam(channelIndex, -1, resolvedName)
      3. If not found, call autoDiscover then retry resolveParam
      4. If still not found, return error with available params list
      5. Call connection.executeCommand('plugins.set_param', { paramIndex, value, index, slotIndex: -1 })
      6. Update shadowState.set()
      7. Return success message with param name and value percentage

    **Tool 2: serum_apply_recipe**
    - Description: "Apply a sound design recipe to Serum 2. Creates a complete sound from a description like 'warm pad' or 'supersaw lead'."
    - Schema: { recipe: z.string(), channelIndex: z.number().int().min(0).optional() }
    - Logic:
      1. Call findRecipes(recipe) to search
      2. If no match, return error listing available recipe names
      3. Take the first match
      4. Auto-discover if needed (one discovery for the channel)
      5. For each parameter in recipe.parameters: resolveSemanticAlias -> paramCache.resolveParam -> executeCommand set_param -> shadowState.set
      6. Track applied and failed parameters
      7. Return summary: recipe name, description, count applied, any failures

    **Tool 3: serum_browse_presets**
    - Description: "Browse Serum 2 presets on the filesystem. Filter by category (Bass, Leads, Pads, etc.) or search by name."
    - Schema: { category: z.string().optional(), search: z.string().optional(), limit: z.number().int().min(1).max(100).default(20).optional() }
    - Logic:
      1. Call listSerumPresets(category, search)
      2. Truncate to limit
      3. Format as text: category headings, preset names
      4. If empty, mention the preset directory path and suggest setting SERUM2_PRESET_DIR env var

    **Tool 4: serum_next_preset**
    - Description: "Navigate to the next preset in Serum 2."
    - Schema: { channelIndex: z.number().int().min(0).optional() }
    - Logic:
      1. Call connection.executeCommand('plugins.next_preset', { index: channelIndex, slotIndex: -1 })
      2. Return the new preset name from the response

    **Tool 5: serum_prev_preset**
    - Description: "Navigate to the previous preset in Serum 2."
    - Schema: { channelIndex: z.number().int().min(0).optional() }
    - Logic: Same as next but calls 'plugins.prev_preset'

    **Tool 6: serum_list_recipes**
    - Description: "List all available Serum 2 sound design recipes."
    - Schema: { category: z.string().optional() }
    - Logic:
      1. If category provided, filter RECIPES by category
      2. Format each recipe: name, category, description, tags
      3. Return formatted list

    Each tool follows the same try/catch pattern as the existing plugin tools. Each tool returns { content: [{ type: 'text', text: ... }] } with optional isError: true for failures.
  </action>
  <verify>
    - `npm run build` passes with no errors
    - `src/tools/serum.ts` exports registerSerumTools function
    - 6 tools registered: serum_set_param, serum_apply_recipe, serum_browse_presets, serum_next_preset, serum_prev_preset, serum_list_recipes
    - All imports resolve correctly (aliases, recipes, presets modules)
    - serum_set_param calls resolveSemanticAlias before paramCache.resolveParam
    - serum_apply_recipe iterates recipe.parameters and sets each via the FL Bridge
  </verify>
  <done>
    6 Serum 2 MCP tools exist in src/tools/serum.ts. serum_set_param resolves semantic aliases then delegates to Phase 4 infrastructure. serum_apply_recipe applies multi-parameter recipes. serum_browse_presets scans filesystem. serum_next_preset/prev_preset navigate via FL Bridge. serum_list_recipes shows available recipes.
  </done>
</task>

<task type="auto">
  <name>Task 2: Register Serum tools in the tools index</name>
  <files>src/tools/index.ts</files>
  <action>
    Update `src/tools/index.ts`:

    1. Add import: `import { registerSerumTools } from './serum.js';`
    2. Add call in registerTools function: `registerSerumTools(server, connection);`
    3. Update the console.error log to include 'serum': `console.error('[fl-studio-mcp] Registered tools: transport, state, patterns, notes, humanize, plugins, serum');`
  </action>
  <verify>
    - `npm run build` passes
    - `src/tools/index.ts` imports registerSerumTools
    - registerSerumTools is called in registerTools function
    - Console log updated to list serum tools
  </verify>
  <done>
    Serum tools registered in MCP server index. All 6 Serum tools available to Claude clients alongside existing tools.
  </done>
</task>

</tasks>

<verification>
- npm run build succeeds with zero errors
- src/tools/serum.ts exports registerSerumTools with 6 tools
- src/tools/index.ts imports and calls registerSerumTools
- serum_set_param resolves aliases before setting params
- serum_apply_recipe finds recipes and applies all parameters
- serum_browse_presets scans filesystem with graceful error handling
- serum_next_preset and serum_prev_preset call FL Bridge preset handlers
- serum_list_recipes returns formatted recipe list
</verification>

<success_criteria>
- All 4 Phase 5 requirements satisfied:
  - SER-01: serum_set_param controls oscillators, filters, macros, FX via semantic names
  - SER-02: resolveSemanticAlias + Phase 4 fuzzy matching provides resilient name resolution
  - SER-03: serum_apply_recipe creates sounds from multi-parameter recipes
  - SER-04: serum_browse_presets + serum_next/prev_preset browse and load presets
- TypeScript compiles cleanly
- All tools follow existing project patterns (error handling, response format, zod schemas)
</success_criteria>

<output>
After completion, create `.planning/phases/05-serum-2-sound-design/05-03-SUMMARY.md`
</output>
