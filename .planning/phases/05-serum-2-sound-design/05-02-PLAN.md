---
phase: 05-serum-2-sound-design
plan: 02
type: execute
wave: 2
depends_on: ["05-01"]
files_modified:
  - src/plugins/serum/recipes.ts
  - src/plugins/serum/presets.ts
  - fl-bridge/handlers/plugins.py
autonomous: true

must_haves:
  truths:
    - "User can find a sound design recipe by name or category (e.g., 'warm pad', 'bass', 'pluck')"
    - "Recipes define multi-parameter configurations using semantic alias names"
    - "FL Bridge can navigate plugin presets (next/prev) and report current preset name"
    - "Serum 2 preset files can be browsed by category and searched by name from filesystem"
  artifacts:
    - path: "src/plugins/serum/recipes.ts"
      provides: "Sound design recipe definitions and search function"
      exports: ["RECIPES", "findRecipes"]
    - path: "src/plugins/serum/presets.ts"
      provides: "Filesystem-based Serum 2 preset browsing"
      exports: ["listSerumPresets", "getSerumPresetDir"]
    - path: "fl-bridge/handlers/plugins.py"
      provides: "Preset navigation handlers (next, prev, count, current name)"
      contains: "handle_plugin_next_preset"
  key_links:
    - from: "src/plugins/serum/recipes.ts"
      to: "src/plugins/serum/aliases.ts"
      via: "Recipe parameter names are semantic aliases resolved by resolveSemanticAlias"
      pattern: "resolveSemanticAlias"
    - from: "fl-bridge/handlers/plugins.py"
      to: "FL Studio plugins module"
      via: "plugins.nextPreset, plugins.prevPreset, plugins.getName"
      pattern: "plugins\\.nextPreset"
---

<objective>
Create sound design recipes for common Serum 2 sound types and implement preset browsing via both FL Studio API and filesystem scanning.

Purpose: Recipes let users say "create a warm pad" and get a multi-parameter configuration applied. Preset browsing lets users navigate and load Serum 2's factory and user presets. Together these enable the creative sound design workflow.

Output: `src/plugins/serum/recipes.ts` with recipe definitions, `src/plugins/serum/presets.ts` with filesystem preset scanning, and updated `fl-bridge/handlers/plugins.py` with preset navigation handlers.
</objective>

<execution_context>
@C:\Users\jared\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\jared\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-serum-2-sound-design/05-RESEARCH.md
@.planning/phases/05-serum-2-sound-design/05-01-SUMMARY.md
@src/plugins/serum/types.ts
@src/plugins/serum/aliases.ts
@fl-bridge/handlers/plugins.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create sound design recipes and preset filesystem scanner</name>
  <files>src/plugins/serum/recipes.ts, src/plugins/serum/presets.ts</files>
  <action>
    **File 1: src/plugins/serum/recipes.ts**

    Import the SoundRecipe type from `./types.js`.

    Create the RECIPES array with at least 6 recipes covering all categories:

    1. **"warm pad"** (category: pad) - Detuned oscillators, low-pass filter with moderate cutoff, slow attack, long release, wide stereo. Tags: ambient, lush, wide, atmospheric.

    2. **"supersaw lead"** (category: lead) - Saw waveform, many unison voices, high detune, bright filter, fast attack. Tags: bright, aggressive, edm, trance.

    3. **"sub bass"** (category: bass) - Single oscillator, sine/low wavetable position, minimal unison, low-pass filter fully open or closed, short attack/decay. Tags: deep, sub, 808, minimal.

    4. **"pluck"** (category: pluck) - Fast attack, short decay, low sustain, moderate release, filter envelope modulation. Tags: short, staccato, percussive.

    5. **"analog keys"** (category: keys) - Two oscillators slightly detuned, medium filter, moderate envelope. Tags: vintage, retro, electric piano.

    6. **"atmospheric fx"** (category: fx) - Long attack, reverb-heavy, modulated filter, noise layer. Tags: ambient, texture, cinematic, evolving.

    All recipe parameter names MUST use semantic alias names that exist in the aliases.ts SERUM_ALIASES array. The recipe application code will call resolveSemanticAlias on each name before setting it.

    Recipe parameter values should be moderate/musical -- not extreme values. These are starting points users will tweak.

    Export:
    - `RECIPES: SoundRecipe[]` - the recipe array
    - `findRecipes(query: string): SoundRecipe[]` - search by name, description, category, or tags (case-insensitive substring matching)
    - `listRecipeNames(): string[]` - return all recipe names for browsing

    **File 2: src/plugins/serum/presets.ts**

    Import SerumPresetInfo from `./types.js`.

    Implement filesystem-based preset browsing:

    ```typescript
    import { readdir } from 'node:fs/promises';
    import { join, extname, basename } from 'node:path';
    import { homedir } from 'node:os';

    const DEFAULT_SERUM2_PRESET_DIR = join(
      homedir(), 'Documents', 'Xfer', 'Serum 2 Presets', 'Presets'
    );
    ```

    Export:
    - `getSerumPresetDir(): string` - returns the preset directory path (reads from SERUM2_PRESET_DIR env var, or falls back to default)
    - `listSerumPresets(filterCategory?: string, filterName?: string): Promise<SerumPresetInfo[]>` - recursive scan of preset directory, returns matching presets. Recognizes .fxp and .SerumPreset extensions. Category is the immediate parent folder name.

    Handle edge cases:
    - Directory doesn't exist: return empty array with no error (not every user has Serum 2 presets in the default location)
    - Permission errors: catch and return empty array
    - No matches: return empty array
  </action>
  <verify>
    - `npm run build` passes
    - `src/plugins/serum/recipes.ts` exports RECIPES (6+ entries), findRecipes, listRecipeNames
    - `src/plugins/serum/presets.ts` exports listSerumPresets, getSerumPresetDir
    - `findRecipes('pad')` would return the warm pad recipe
    - `findRecipes('bass')` would return the sub bass recipe
    - All recipe parameter names are semantic aliases that exist in the SERUM_ALIASES array
  </verify>
  <done>
    6+ sound design recipes covering pad, lead, bass, pluck, keys, fx categories. Preset filesystem scanner handles default Serum 2 location with configurable override. findRecipes search works by name, category, description, and tags.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add preset navigation handlers to FL Bridge</name>
  <files>fl-bridge/handlers/plugins.py</files>
  <action>
    Add three new handlers to the existing plugins.py file. Append them AFTER the existing handlers but BEFORE the register_handler lines at the bottom. Then add register_handler calls for the new handlers.

    **Handler 1: handle_plugin_next_preset**
    ```python
    def handle_plugin_next_preset(params):
        """Navigate to the next preset in the plugin's preset list."""
        index = params.get('index', channels.selectedChannel())
        slot_index = params.get('slotIndex', -1)

        if not plugins.isValid(index, slot_index):
            return {'success': False, 'error': f'No valid plugin at channel {index}, slot {slot_index}'}

        plugins.nextPreset(index, slot_index)
        # Get the new preset name using FPN_Preset flag
        preset_name = plugins.getName(index, slot_index, 6, 0)  # 6 = FPN_Preset
        return {'success': True, 'presetName': preset_name, 'channelIndex': index, 'slotIndex': slot_index}
    ```

    **Handler 2: handle_plugin_prev_preset**
    Same pattern but calls `plugins.prevPreset(index, slot_index)`.

    **Handler 3: handle_plugin_preset_count**
    ```python
    def handle_plugin_preset_count(params):
        """Get the total number of presets for a plugin."""
        index = params.get('index', channels.selectedChannel())
        slot_index = params.get('slotIndex', -1)

        if not plugins.isValid(index, slot_index):
            return {'success': False, 'error': f'No valid plugin at channel {index}, slot {slot_index}'}

        count = plugins.getPresetCount(index, slot_index)
        current_name = plugins.getName(index, slot_index, 6, 0)  # FPN_Preset
        return {'success': True, 'presetCount': count, 'currentPreset': current_name, 'channelIndex': index, 'slotIndex': slot_index}
    ```

    Import `midi` module at the top alongside existing imports (for the FPN_Preset constant). NOTE: If the `midi` module import fails outside FL Studio, use the raw constant value 6 for FPN_Preset instead.

    Register all three:
    ```python
    register_handler('plugins.next_preset', handle_plugin_next_preset)
    register_handler('plugins.prev_preset', handle_plugin_prev_preset)
    register_handler('plugins.preset_count', handle_plugin_preset_count)
    ```

    Wrap each handler body in try/except like existing handlers.
  </action>
  <verify>
    - Python syntax check passes: `python -c "import ast; ast.parse(open('fl-bridge/handlers/plugins.py').read())"`
    - All six handlers registered: discover, get_param, set_param, next_preset, prev_preset, preset_count
    - Each new handler follows same error handling pattern as existing handlers
    - FPN_Preset constant is 6 (hardcoded, not relying on midi module import)
  </verify>
  <done>
    FL Bridge plugins.py has 6 registered handlers. Preset navigation (next/prev/count) follows same patterns as existing discover/get/set handlers. Each returns success/error dict with preset name and channel info.
  </done>
</task>

</tasks>

<verification>
- src/plugins/serum/recipes.ts exists with 6+ recipes and findRecipes search
- src/plugins/serum/presets.ts exists with filesystem preset browsing
- fl-bridge/handlers/plugins.py has 6 registered handlers (3 existing + 3 new)
- npm run build succeeds
- Python syntax valid for updated plugins.py
</verification>

<success_criteria>
- 6+ sound recipes covering pad, lead, bass, pluck, keys, fx
- findRecipes can search by name, category, description, and tags
- Preset filesystem scanner handles missing directory gracefully
- FL Bridge preset handlers (next/prev/count) are registered and follow existing patterns
- TypeScript compiles cleanly
</success_criteria>

<output>
After completion, create `.planning/phases/05-serum-2-sound-design/05-02-SUMMARY.md`
</output>
