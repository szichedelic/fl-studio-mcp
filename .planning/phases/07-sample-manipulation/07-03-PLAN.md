---
phase: 07-sample-manipulation
plan: 03
type: execute
wave: 3
depends_on: ["07-02"]
files_modified:
  - src/tools/sample.ts
autonomous: true

must_haves:
  truths:
    - "User can layer multiple WAV files together into a single mixed file"
    - "User can create a stereo-detuned version of a sample with configurable detune cents and optional micro-delay"
    - "Temporary files from the stereo detune pipeline are cleaned up even on error"
    - "User can execute a full resampling workflow by chaining existing tools (no new tool needed for SAM-05)"
  artifacts:
    - path: "src/tools/sample.ts"
      provides: "sample_layer MCP tool with mix and stereo detune modes"
      contains: "sample_layer"
  key_links:
    - from: "src/tools/sample.ts (sample_layer)"
      to: "src/audio/sox-runner.ts"
      via: "soxRunner.pitch, soxRunner.merge, soxRunner.mix, soxRunner.normalize"
      pattern: "soxRunner\\.(pitch|merge|mix|normalize)"
    - from: "src/tools/sample.ts (sample_layer stereo detune)"
      to: "temp files"
      via: "try/finally cleanup of _L_tmp.wav and _R_tmp.wav"
      pattern: "finally.*unlink"
---

<objective>
Add the sample_layer MCP tool that handles both simple mixing/layering of multiple files AND the stereo detune pipeline for creating wide, rich textures from a single sample.

Purpose: This delivers SAM-04 (layer and mix multiple audio files with stereo detune effects). The stereo detune is a multi-step SoX pipeline (pitch L/R at +/- cents, optional micro-delay, merge to stereo, normalize) that is the most complex operation in Phase 7. SAM-05 (full resampling workflow) is orchestration of existing tools -- no new code needed.

Output: Updated `src/tools/sample.ts` with the sample_layer tool added.
</objective>

<execution_context>
@C:\Users\jared\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\jared\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-sample-manipulation/07-RESEARCH.md
@.planning/phases/07-sample-manipulation/07-01-SUMMARY.md
@.planning/phases/07-sample-manipulation/07-02-SUMMARY.md
@src/tools/sample.ts
@src/audio/sox-runner.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add sample_layer tool with mix and stereo detune modes</name>
  <files>src/tools/sample.ts</files>
  <action>
Add a new `sample_layer` tool registration inside the existing `registerSampleTools` function in `src/tools/sample.ts`. Add any new imports needed at the top of the file (`unlink` from `node:fs/promises`, `extname` from `node:path` if not already imported, `tmpdir` from `node:os` if desired).

**Tool: sample_layer** (SAM-04)
- Name: `'sample_layer'`
- Description: `'Layer and mix audio files, or create a stereo-detuned version of a single sample for rich, wide textures. Supports two modes: "mix" layers multiple files together, "stereo_detune" creates a wide stereo effect from one file.'`
- Schema:
  - `inputs`: z.array(z.string()).min(1).describe('Input WAV filenames (from list_renders) or absolute paths. For stereo_detune mode, provide exactly 1 file.')
  - `mode`: z.enum(['mix', 'stereo_detune']).default('mix').describe('Mode: "mix" to layer multiple files together, "stereo_detune" to create a stereo-widened version of a single sample.')
  - `detuneCents`: z.number().min(1).max(50).default(8).optional().describe('For stereo_detune mode: detune amount in cents. 8 cents is subtle and musical. Range: 1-50.')
  - `delayMs`: z.number().min(0).max(30).default(0).optional().describe('For stereo_detune mode: micro-delay in ms applied to right channel for extra width. 0 = no delay. 10-15ms is typical for Haas effect.')
  - `outputFilename`: z.string().optional().describe('Custom output filename. Omit for auto-generated name.')
- Handler:

**Mix mode** (when mode === 'mix'):
1. Resolve all inputs: `const inputPaths = inputs.map(resolveInputFile)`
2. Validate at least 2 inputs, otherwise return error: "Mix mode requires at least 2 input files."
3. Generate output name from first input filename, operation='layered', suffix=`${inputPaths.length}files`
4. `const outputPath = join(getDefaultSampleDir(), outName)`
5. `await mkdir(dirname(outputPath), { recursive: true })`
6. Auto-balance volumes: `const volumes = inputPaths.map(() => 1 / inputPaths.length)` -- this prevents clipping when mixing
7. `const mixResult = await soxRunner.mix(inputPaths, outputPath, volumes)`
8. Normalize the result: `await soxRunner.normalize(outputPath, outputPath + '.tmp')` then rename the temp to outputPath. Actually, simpler: mix to a temp path, then normalize temp to final output, then delete temp. OR: just mix with the balanced volumes (should be fine without normalize for typical use). Let's keep it simple: mix with auto-balanced volumes, skip normalize unless clipping is reported.

   Correction -- do normalize. Here's the clean approach:
   - Mix to a temporary path: `const tmpMixed = outputPath.replace('.wav', '_tmp_mix.wav')`
   - `await soxRunner.mix(inputPaths, tmpMixed, volumes)`
   - `await soxRunner.normalize(tmpMixed, outputPath)`
   - `await unlink(tmpMixed).catch(() => {})` (cleanup)
9. Return text content listing all input files, the output path, and FL Studio instruction

**Stereo detune mode** (when mode === 'stereo_detune'):
1. Validate exactly 1 input: `if (inputs.length !== 1) return error "Stereo detune mode requires exactly 1 input file."`
2. `const inputPath = resolveInputFile(inputs[0])`
3. `const cents = detuneCents ?? 8`
4. `const delay = delayMs ?? 0`
5. Generate output name from input filename, operation='stereo_detune', suffix=`${cents}c` (and `_${delay}ms` if delay > 0)
6. `const outputPath = join(getDefaultSampleDir(), outName)`
7. `await mkdir(dirname(outputPath), { recursive: true })`

**Stereo detune pipeline** (wrap entire pipeline in try/finally for temp cleanup):

```typescript
const base = basename(outputPath, '.wav');
const dir = dirname(outputPath);
const leftTmp = join(dir, `${base}_L_tmp.wav`);
const rightTmp = join(dir, `${base}_R_tmp.wav`);
const rightDelayedTmp = join(dir, `${base}_R_delayed_tmp.wav`);
const mergedTmp = join(dir, `${base}_merged_tmp.wav`);

try {
  // Step 1: Pitch-shift up for left channel
  await soxRunner.pitch(inputPath, leftTmp, cents);

  // Step 2: Pitch-shift down for right channel
  await soxRunner.pitch(inputPath, rightTmp, -cents);

  // Step 3: Optional micro-delay on right channel
  let rightSource = rightTmp;
  if (delay > 0) {
    const delaySec = (delay / 1000).toFixed(4);
    await soxRunner.run([rightTmp, rightDelayedTmp, 'delay', delaySec]);
    rightSource = rightDelayedTmp;
  }

  // Step 4: Merge left + right into stereo
  await soxRunner.merge([leftTmp, rightSource], mergedTmp);

  // Step 5: Normalize to prevent clipping
  await soxRunner.normalize(mergedTmp, outputPath);
} finally {
  // Clean up ALL temp files
  const temps = [leftTmp, rightTmp, rightDelayedTmp, mergedTmp];
  await Promise.all(temps.map(f => unlink(f).catch(() => {})));
}
```

8. Return text content describing: what was done (detune cents, delay ms, stereo widening), input path, output path, and FL Studio instruction.

**Error handling:** Same try/catch pattern as other tools, returning `isError: true` with descriptive message.
  </action>
  <verify>
1. Run `npx tsc --noEmit` -- should compile cleanly
2. Run `npm run build` -- should succeed
  </verify>
  <done>sample_layer tool exists with both mix and stereo_detune modes. Stereo detune implements the full pipeline (pitch L/R, optional delay, merge, normalize) with temp file cleanup.</done>
</task>

<task type="auto">
  <name>Task 2: Final build verification and tool inventory</name>
  <files>(no new files -- verification only)</files>
  <action>
1. Run `npm run build` to produce a clean dist/ output
2. Verify the complete tool inventory by checking that `src/tools/sample.ts` contains all 5 tool registrations: sample_pitch, sample_reverse, sample_timestretch, sample_info, sample_layer
3. Verify `src/tools/index.ts` calls `registerSampleTools`
4. Verify `src/index.ts` has the SoX startup check
5. Verify no unused imports or TypeScript warnings

If any issues are found, fix them. This is a final quality gate before the phase is considered complete.
  </action>
  <verify>
1. `npm run build` completes with zero errors
2. All 5 sample tools are present in the built output
3. No TypeScript warnings or unused imports
  </verify>
  <done>Phase 7 builds cleanly. All 5 MCP sample tools (sample_pitch, sample_reverse, sample_timestretch, sample_info, sample_layer) are registered and compilable. SoX startup check is in place.</done>
</task>

</tasks>

<verification>
1. `npm run build` succeeds
2. `src/tools/sample.ts` contains all 5 tool registrations
3. sample_layer supports both 'mix' and 'stereo_detune' modes
4. Stereo detune pipeline creates and cleans up temp files in try/finally
5. All tools accept render registry filenames and absolute paths
6. SAM-01 through SAM-04 requirements are covered by the tools
7. SAM-05 is achievable by chaining existing tools (no new tool needed)

Phase 7 success criteria verification:
- [SAM-01] sample_pitch: pitch shift by semitones -> COVERED
- [SAM-02] sample_reverse: reverse audio -> COVERED
- [SAM-03] sample_timestretch: time stretch by factor -> COVERED
- [SAM-04] sample_layer: mix multiple files + stereo detune -> COVERED
- [SAM-05] Full resampling workflow: chain note generation (Phase 2) + render (Phase 6) + manipulate (Phase 7 tools) + reload instructions -> COVERED by tool orchestration
</verification>

<success_criteria>
- sample_layer tool handles both simple mixing and complex stereo detune pipeline
- Stereo detune creates rich, wide textures from a single sample
- Temp files are always cleaned up (even on error)
- Full build passes
- All Phase 7 requirements (SAM-01 through SAM-05) are addressable
</success_criteria>

<output>
After completion, create `.planning/phases/07-sample-manipulation/07-03-SUMMARY.md`
</output>
