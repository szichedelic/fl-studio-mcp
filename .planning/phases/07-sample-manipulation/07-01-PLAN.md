---
phase: 07-sample-manipulation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/audio/types.ts
  - src/audio/sox-runner.ts
autonomous: true

must_haves:
  truths:
    - "SoxRunner can verify SoX availability and return version string"
    - "SoxRunner can execute pitch, reverse, tempo, mix, merge, and info commands"
    - "SoxRunner resolves SoX path from SOX_PATH env var or falls back to 'sox'"
    - "File resolution finds renders by registry filename, absolute path, or default renders dir"
  artifacts:
    - path: "src/audio/sox-runner.ts"
      provides: "SoX command builder and executor class"
      exports: ["SoxRunner", "soxRunner", "SoxResult", "resolveInputFile", "generateOutputFilename", "getDefaultSampleDir"]
    - path: "src/audio/types.ts"
      provides: "SoxResult and SampleInfo type definitions"
      contains: "SoxResult"
  key_links:
    - from: "src/audio/sox-runner.ts"
      to: "node:child_process"
      via: "promisify(execFile)"
      pattern: "execFile.*sox"
    - from: "src/audio/sox-runner.ts"
      to: "src/audio/render-registry.ts"
      via: "resolveInputFile uses renderRegistry.getByFilename"
      pattern: "renderRegistry\\.getByFilename"
---

<objective>
Create the SoxRunner class that encapsulates all SoX CLI interactions, plus the shared file resolution and output naming utilities that all sample tools will use.

Purpose: This is the foundation layer for Phase 7. Every sample manipulation tool delegates to SoxRunner for actual audio processing. The file resolution utility connects Phase 6 renders to Phase 7 operations.

Output: Two files -- `src/audio/sox-runner.ts` (SoxRunner class + utilities) and updated `src/audio/types.ts` (new types).
</objective>

<execution_context>
@C:\Users\jared\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\jared\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-sample-manipulation/07-RESEARCH.md
@src/audio/types.ts
@src/audio/render-registry.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add SoxResult and SampleInfo types to audio types</name>
  <files>src/audio/types.ts</files>
  <action>
Add the following types to the existing `src/audio/types.ts` file (append after the existing types, do NOT modify existing RenderInfo or WatcherConfig):

```typescript
/** Result of a SoX operation. */
export interface SoxResult {
  /** Absolute path to the output WAV file. */
  outputPath: string;
  /** The SoX command that was executed (for debugging/logging). */
  command: string;
}

/** Metadata about a WAV audio file, retrieved via SoX --i. */
export interface SampleInfo {
  /** Absolute path to the file. */
  path: string;
  /** Sample rate in Hz (e.g., 44100). */
  sampleRate: number;
  /** Number of audio channels (1=mono, 2=stereo). */
  channels: number;
  /** Duration in seconds. */
  duration: number;
  /** Total number of samples. */
  samples: number;
  /** Bit depth as string (e.g., "16-bit", "24-bit"). */
  precision: string;
}
```
  </action>
  <verify>Run `npx tsc --noEmit` -- should compile with no errors.</verify>
  <done>SoxResult and SampleInfo types exist in src/audio/types.ts alongside existing types.</done>
</task>

<task type="auto">
  <name>Task 2: Create SoxRunner class with file resolution utilities</name>
  <files>src/audio/sox-runner.ts</files>
  <action>
Create `src/audio/sox-runner.ts` with the following:

**SoxRunner class:**
- Constructor accepts optional `soxPath` parameter. Default: `process.env.SOX_PATH || 'sox'`.
- Uses `promisify(execFile)` from `node:child_process` and `node:util`. Import `execFile as execFileCb` from child_process.
- `async verify(): Promise<string>` -- Runs `sox --version`, returns version string. On error, throws with clear installation message: "SoX is not installed or not in PATH. Install via: winget install --id ChrisBagwell.SoX -s winget"
- `async run(args: string[]): Promise<{ stdout: string; stderr: string }>` -- Executes `execFile(this.soxPath, args, { timeout: 120_000 })`. This is the core executor.
- `async pitch(input: string, output: string, cents: number): Promise<SoxResult>` -- Args: `[input, output, 'pitch', String(cents)]`
- `async reverse(input: string, output: string): Promise<SoxResult>` -- Args: `[input, output, 'reverse']`
- `async tempo(input: string, output: string, factor: number): Promise<SoxResult>` -- Args: `[input, output, 'tempo', '-m', String(factor)]`. The `-m` flag = music mode (best for synthesizer content).
- `async mix(inputs: string[], output: string, volumes?: number[]): Promise<SoxResult>` -- If volumes provided, interleave `-v {vol}` before each input. Args: `['-m', ...interleaved, output]`. If no volumes, auto-balance: each gets `1/inputs.length` volume.
- `async merge(inputs: string[], output: string): Promise<SoxResult>` -- Args: `['-M', ...inputs, output]`
- `async normalize(input: string, output: string): Promise<SoxResult>` -- Args: `[input, output, 'gain', '-n']`
- `async info(input: string): Promise<SampleInfo>` -- Runs `['--i', input]`, parses stdout. Parse these fields from the output using regex:
  - `Channels\s*:\s*(\d+)` -> channels
  - `Sample Rate\s*:\s*(\d+)` -> sampleRate
  - `Duration\s*:.*=\s*(\d+)\s*samples` -> samples
  - `Precision\s*:\s*(.+)` -> precision (trim)
  - Duration in seconds: `samples / sampleRate`
  - Import and use `SampleInfo` from `./types.js`

All methods that produce output files should return `SoxResult` (imported from `./types.js`). The `command` field should be a human-readable string like `sox input.wav output.wav pitch -1200`.

**Singleton export:**
```typescript
export const soxRunner = new SoxRunner();
```

**File resolution utility function (exported):**
```typescript
export function resolveInputFile(filenameOrPath: string): string
```
- Import `renderRegistry` from `./render-registry.js`
- Import `isAbsolute`, `join` from `node:path`
- Import `existsSync` from `node:fs`
- First: check `renderRegistry.getByFilename(filenameOrPath)` -- if found, return `render.path`
- Second: check `isAbsolute(filenameOrPath) && existsSync(filenameOrPath)` -- if yes, return it
- Third: check in default renders dir: `join(getDefaultRenderDir(), filenameOrPath)` where `getDefaultRenderDir()` returns `join(homedir(), 'Documents', 'FL Studio MCP', 'Renders')`. Import `homedir` from `node:os`.
- Fourth: check in default samples dir: `join(getDefaultSampleDir(), filenameOrPath)`
- If none found, throw Error with message: `File not found: "${filenameOrPath}". Use list_renders to see available files, or provide an absolute path.`

**Output filename generator (exported):**
```typescript
export function generateOutputFilename(inputFilename: string, operation: string, suffix?: string): string
```
- Strip extension from inputFilename using `basename` and `extname` from `node:path`
- Build: `[base, operation, suffix].filter(Boolean).join('_') + '.wav'`

**Default sample directory (exported):**
```typescript
export function getDefaultSampleDir(): string
```
- Returns `join(homedir(), 'Documents', 'FL Studio MCP', 'Samples')`

**Important implementation notes:**
- Use `import { execFile as execFileCb } from 'node:child_process'` (NOT `exec` -- security and correctness)
- `const execFile = promisify(execFileCb)` at module level
- All file paths passed as separate array elements to execFile (never string-interpolated)
- 120 second timeout on all SoX operations (generous for large files)
- SoX stderr is informational, not always an error -- only `execFile` rejection means failure
  </action>
  <verify>Run `npx tsc --noEmit` -- should compile with no errors. Verify the file exports SoxRunner, soxRunner, resolveInputFile, generateOutputFilename, and getDefaultSampleDir.</verify>
  <done>SoxRunner class exists with all audio processing methods (pitch, reverse, tempo, mix, merge, normalize, info), plus resolveInputFile and generateOutputFilename utilities. The singleton soxRunner is exported for use by tools.</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` compiles cleanly
2. `src/audio/sox-runner.ts` exports: SoxRunner class, soxRunner singleton, SoxResult type (re-exported from types), resolveInputFile, generateOutputFilename, getDefaultSampleDir
3. `src/audio/types.ts` contains SoxResult and SampleInfo interfaces alongside existing RenderInfo and WatcherConfig
4. resolveInputFile imports and uses renderRegistry for filename resolution
5. No new npm dependencies added (all Node.js built-ins)
</verification>

<success_criteria>
- SoxRunner class fully typed with all SoX operations needed for Phase 7
- File resolution connects Phase 6 render registry to Phase 7 input
- Output filename generator produces descriptive names
- TypeScript compiles cleanly
</success_criteria>

<output>
After completion, create `.planning/phases/07-sample-manipulation/07-01-SUMMARY.md`
</output>
