---
phase: 11-project-controls
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - fl-bridge/handlers/project.py
  - fl-bridge/handlers/__init__.py
  - src/tools/project.ts
  - src/tools/index.ts
autonomous: true

must_haves:
  truths:
    - "User can read current tempo in BPM"
    - "User can set tempo to any value between 10-999 BPM"
    - "User can read playback position in bars, steps, ticks, and milliseconds"
    - "User can jump to a specific bar, tick, or time position"
  artifacts:
    - path: "fl-bridge/handlers/project.py"
      provides: "Python handlers for tempo and position"
      exports: ["handle_project_get_tempo", "handle_project_set_tempo", "handle_project_get_position", "handle_project_set_position"]
    - path: "src/tools/project.ts"
      provides: "MCP tool wrappers for project handlers"
      exports: ["registerProjectTools"]
  key_links:
    - from: "src/tools/project.ts"
      to: "fl-bridge/handlers/project.py"
      via: "connection.executeCommand"
      pattern: "project\\.(get|set)_(tempo|position)"
    - from: "fl-bridge/handlers/project.py"
      to: "FL Studio API"
      via: "mixer.getCurrentTempo, general.processRECEvent, transport.getSongPos/setSongPos"
      pattern: "(mixer\\.getCurrentTempo|general\\.processRECEvent|transport\\.(get|set)SongPos)"
---

<objective>
Implement tempo and playback position control for FL Studio via MCP tools.

Purpose: Enable users to read/set project tempo and navigate to specific positions using natural language commands like "set tempo to 128 BPM" or "go to bar 16".

Output: 4 Python handlers (get_tempo, set_tempo, get_position, set_position) and 4 MCP tools.
</objective>

<execution_context>
@C:\Users\jared\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\jared\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-project-controls/11-RESEARCH.md

@fl-bridge/handlers/transport.py (reference for handler patterns)
@src/tools/transport.ts (reference for tool patterns)
@fl-bridge/handlers/__init__.py (needs import added)
@src/tools/index.ts (needs registration added)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Python handlers for tempo and position</name>
  <files>
    fl-bridge/handlers/project.py
    fl-bridge/handlers/__init__.py
  </files>
  <action>
Create `fl-bridge/handlers/project.py` with 4 handlers following the transport.py pattern:

1. **handle_project_get_tempo** (project.get_tempo):
   - Use `mixer.getCurrentTempo()` to read BPM as float
   - Return `{success: True, tempo: float, bpm: int}` (bpm is rounded)
   - Handle missing mixer module gracefully

2. **handle_project_set_tempo** (project.set_tempo):
   - Accept `bpm` param (float, 10-999 range)
   - CRITICAL: Multiply by 1000 for processRECEvent (`bpm * 1000`)
   - Use `general.processRECEvent(midi.REC_Tempo, tempo_value, flags)`
   - flags = `midi.REC_Control | midi.REC_UpdateControl` (updates UI)
   - Read back via getCurrentTempo() to confirm
   - Return `{success: True, tempo: float, requested: float}`

3. **handle_project_get_position** (project.get_position):
   - Use `transport.getSongPos(mode)` with multiple modes:
     - Mode 3: bars component
     - Mode 4: steps component
     - Mode 5: ticks component
     - Mode 2: absolute ticks
     - Mode 0: milliseconds
     - Mode -1: fractional (0.0-1.0)
   - Include `transport.getSongPosHint()` for formatted B:S:T string
   - Return all formats in response

4. **handle_project_set_position** (project.set_position):
   - Accept one of: `bars`, `ticks`, `ms`, `seconds`, `fractional`
   - For bars input: convert to absolute ticks using `(bars - 1) * general.getRecPPQ() * 4` (assumes 4/4)
   - Use `transport.setSongPos(value, mode)` - only modes -1, 0, 1, 2 work for writing
   - Read back position to confirm
   - Return bars/steps/ticks and hint

Register all handlers:
```python
register_handler('project.get_tempo', handle_project_get_tempo)
register_handler('project.set_tempo', handle_project_set_tempo)
register_handler('project.get_position', handle_project_get_position)
register_handler('project.set_position', handle_project_set_position)
```

Update `fl-bridge/handlers/__init__.py` to import the new module:
```python
from handlers import project
```

Anti-patterns to AVOID (from research):
- Do NOT use modes 3-5 for setSongPos (read-only)
- Do NOT forget the * 1000 multiplier for tempo
- Do NOT omit REC_UpdateControl flag (UI won't update)
  </action>
  <verify>
1. File exists: `fl-bridge/handlers/project.py`
2. File has docstring with REGISTERED HANDLERS section listing all 4 handlers
3. All 4 register_handler calls present
4. __init__.py imports project module
5. grep confirms `bpm * 1000` pattern (not `bpm` alone to processRECEvent)
6. grep confirms `REC_Control | REC_UpdateControl` flag pattern
  </verify>
  <done>
Python handlers created and registered. tempo/position get/set functions implemented with proper API calls and error handling.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create TypeScript MCP tools for tempo and position</name>
  <files>
    src/tools/project.ts
    src/tools/index.ts
  </files>
  <action>
Create `src/tools/project.ts` following the transport.ts pattern:

1. **get_tempo** tool:
   - No params needed
   - Description: "Get current project tempo (BPM)"
   - Calls `project.get_tempo` handler

2. **set_tempo** tool:
   - Params: `bpm: z.number().min(10).max(999).describe('Tempo in BPM (10-999)')`
   - Description: "Set project tempo in BPM"
   - Calls `project.set_tempo` handler with {bpm}

3. **get_position** tool:
   - No params needed
   - Description: "Get current playback position (bars, steps, ticks, ms)"
   - Calls `project.get_position` handler

4. **set_position** tool:
   - Params: Accept ONE of these (all optional, but require at least one):
     - `bars: z.number().min(1).optional().describe('Bar number (1-indexed)')`
     - `ticks: z.number().min(0).optional().describe('Absolute tick position')`
     - `ms: z.number().min(0).optional().describe('Position in milliseconds')`
     - `seconds: z.number().min(0).optional().describe('Position in seconds')`
   - Description: "Jump to playback position (by bars, ticks, ms, or seconds)"
   - Calls `project.set_position` handler with provided param

Export `registerProjectTools(server, connection)` function.

Update `src/tools/index.ts`:
1. Add import: `import { registerProjectTools } from './project.js';`
2. Add call in registerTools: `registerProjectTools(server, connection);`
3. Update console.error log to include 'project' in the list
  </action>
  <verify>
1. File exists: `src/tools/project.ts`
2. TypeScript compiles without errors: `npx tsc --noEmit`
3. All 4 tools registered (get_tempo, set_tempo, get_position, set_position)
4. index.ts imports and calls registerProjectTools
5. Tool descriptions are clear and actionable
  </verify>
  <done>
TypeScript MCP tools created and registered. Users can now get/set tempo and position via natural language.
  </done>
</task>

</tasks>

<verification>
After both tasks complete:

1. **TypeScript builds:** `npm run build` succeeds
2. **Handlers registered:** grep confirms all 4 project.* handlers in project.py
3. **Tools registered:** grep confirms all 4 tool registrations in project.ts
4. **Integration wired:** index.ts calls registerProjectTools, __init__.py imports project
</verification>

<success_criteria>
- [ ] `fl-bridge/handlers/project.py` exists with 4 handlers
- [ ] `src/tools/project.ts` exists with 4 MCP tools
- [ ] TypeScript compiles without errors
- [ ] Handlers registered in __init__.py
- [ ] Tools registered in index.ts
- [ ] Tempo setting uses * 1000 multiplier
- [ ] Position setting uses correct modes (not 3-5)
</success_criteria>

<output>
After completion, create `.planning/phases/11-project-controls/11-01-SUMMARY.md`
</output>
