---
phase: 11-project-controls
plan: 02
type: execute
wave: 2
depends_on: ["11-01"]
files_modified:
  - fl-bridge/handlers/project.py
  - src/tools/project.ts
autonomous: true

must_haves:
  truths:
    - "User can undo the last operation"
    - "User can redo a previously undone operation"
  artifacts:
    - path: "fl-bridge/handlers/project.py"
      provides: "Python handlers for undo and redo"
      exports: ["handle_project_undo", "handle_project_redo"]
    - path: "src/tools/project.ts"
      provides: "MCP tool wrappers for undo/redo"
      exports: ["undo", "redo tools"]
  key_links:
    - from: "src/tools/project.ts"
      to: "fl-bridge/handlers/project.py"
      via: "connection.executeCommand"
      pattern: "project\\.(undo|redo)"
    - from: "fl-bridge/handlers/project.py"
      to: "FL Studio API"
      via: "general.undoUp and general.undoDown"
      pattern: "general\\.undo(Up|Down)"
---

<objective>
Add undo and redo operations to FL Studio project controls.

Purpose: Enable users to undo/redo operations with natural language commands like "undo that" or "redo".

Output: 2 Python handlers (undo, redo) and 2 MCP tools added to existing project files.
</objective>

<execution_context>
@C:\Users\jared\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\jared\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-project-controls/11-RESEARCH.md
@.planning/phases/11-project-controls/11-01-SUMMARY.md

@fl-bridge/handlers/project.py (extend with undo/redo)
@src/tools/project.ts (extend with undo/redo)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add undo/redo Python handlers</name>
  <files>
    fl-bridge/handlers/project.py
  </files>
  <action>
Extend `fl-bridge/handlers/project.py` with 2 additional handlers:

1. **handle_project_undo** (project.undo):
   - Use `general.undoUp()` - NOT `general.undo()` (undo() is a toggle, unreliable)
   - Return `{success: True, action: 'undo', result: int}` (result meaning unknown but return it)
   - Handle missing general module gracefully

2. **handle_project_redo** (project.redo):
   - Use `general.undoDown()` - NOT `general.undo()`
   - Return `{success: True, action: 'redo', result: int}`
   - Handle missing general module gracefully

Add registrations:
```python
register_handler('project.undo', handle_project_undo)
register_handler('project.redo', handle_project_redo)
```

Update the docstring REGISTERED HANDLERS section to include:
- project.undo: Undo last operation
- project.redo: Redo last undone operation

CRITICAL Anti-pattern to AVOID (from research):
- Do NOT use `general.undo()` - it toggles between undo/redo unpredictably
- ALWAYS use `undoUp()` for undo and `undoDown()` for redo
  </action>
  <verify>
1. grep confirms `general.undoUp()` in handle_project_undo (NOT `general.undo()`)
2. grep confirms `general.undoDown()` in handle_project_redo
3. Both register_handler calls present for project.undo and project.redo
4. Docstring updated with both new handlers
  </verify>
  <done>
Python undo/redo handlers added using correct directional functions (undoUp/undoDown).
  </done>
</task>

<task type="auto">
  <name>Task 2: Add undo/redo TypeScript MCP tools</name>
  <files>
    src/tools/project.ts
  </files>
  <action>
Extend `src/tools/project.ts` with 2 additional tools:

1. **undo** tool:
   - No params needed
   - Description: "Undo the last operation in FL Studio"
   - Calls `project.undo` handler

2. **redo** tool:
   - No params needed
   - Description: "Redo the last undone operation in FL Studio"
   - Calls `project.redo` handler

Both tools follow the same pattern as get_tempo (no params, simple call).
  </action>
  <verify>
1. TypeScript compiles without errors: `npx tsc --noEmit`
2. Both tools registered (undo, redo)
3. Tool descriptions mention "undo" and "redo" clearly
  </verify>
  <done>
TypeScript undo/redo MCP tools added. Users can now undo/redo via natural language.
  </done>
</task>

</tasks>

<verification>
After both tasks complete:

1. **TypeScript builds:** `npm run build` succeeds
2. **All 6 handlers registered:** grep confirms all project.* handlers in project.py
3. **All 6 tools registered:** grep confirms all tool registrations in project.ts
4. **Correct functions used:** grep confirms undoUp/undoDown, NOT undo()
</verification>

<success_criteria>
- [ ] `project.py` has 6 handlers total (4 from plan 01 + 2 new)
- [ ] `project.ts` has 6 tools total (4 from plan 01 + 2 new)
- [ ] TypeScript compiles without errors
- [ ] Uses `undoUp()` for undo (NOT `undo()`)
- [ ] Uses `undoDown()` for redo
</success_criteria>

<output>
After completion, create `.planning/phases/11-project-controls/11-02-SUMMARY.md`
</output>
