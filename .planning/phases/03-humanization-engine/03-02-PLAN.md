---
phase: 03-humanization-engine
plan: 02
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - src/music/humanize/velocity.ts
  - src/music/humanize/note-length.ts
  - src/music/humanize/presets.ts
autonomous: true

must_haves:
  truths:
    - "Drum velocity profile produces ghost notes (0.24-0.39) and accents (0.78-0.94) with wide dynamic range"
    - "Piano velocity breathes with phrase-arc shaping"
    - "Bass velocity stays narrow and consistent (0.63-0.82)"
    - "Note-length variation makes downbeats slightly more legato and upbeats slightly more staccato"
    - "Named presets (tight, loose, jazz, lo-fi) produce distinctly different parameter bundles"
    - "Beat-position awareness makes downbeats more stable than off-beats across all transforms"
  artifacts:
    - path: "src/music/humanize/velocity.ts"
      provides: "Instrument-aware velocity variation with beat-position emphasis"
      exports: ["applyVelocityVariation", "VELOCITY_PROFILES"]
    - path: "src/music/humanize/note-length.ts"
      provides: "Beat-position-aware note-length variation"
      exports: ["applyNoteLengthVariation"]
    - path: "src/music/humanize/presets.ts"
      provides: "Named humanization preset configurations"
      exports: ["getPresetParams", "HUMANIZATION_PRESETS"]
  key_links:
    - from: "src/music/humanize/velocity.ts"
      to: "src/music/humanize/util.ts"
      via: "import getBeatPosition, clampVelocity"
      pattern: "import.*getBeatPosition.*from.*util"
    - from: "src/music/humanize/presets.ts"
      to: "src/music/types.ts"
      via: "import HumanizationParams, HumanizationPreset"
      pattern: "import.*HumanizationParams.*from.*types"
---

<objective>
Implement the velocity variation engine with instrument-aware profiles, beat-position note-length variation, and named humanization presets.

Purpose: Completes the four humanization transforms. Velocity profiles give each instrument its own dynamic character (drums hit differently than piano). Note-length variation adds articulation. Presets bundle everything into user-friendly names ("jazz", "lo-fi") that produce distinctly different musical character.

Output: Three new files -- velocity.ts with instrument profiles and simplex-noise-based variation, note-length.ts with beat-position-aware duration changes, presets.ts with named parameter bundles.
</objective>

<execution_context>
@C:\Users\jared\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\jared\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/03-humanization-engine/03-RESEARCH.md
@.planning/phases/03-humanization-engine/03-01-SUMMARY.md

@src/music/types.ts
@src/music/humanize/util.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Instrument-aware velocity variation with simplex noise</name>
  <files>src/music/humanize/velocity.ts</files>
  <action>
Create `src/music/humanize/velocity.ts`.

1. Define and export `VELOCITY_PROFILES` object with profiles for each instrument type. Use the exact values from RESEARCH.md:

```typescript
export const VELOCITY_PROFILES = {
  drums: {
    baseVelocityRange: [0.3, 1.0] as [number, number],
    downbeatBoost: 0.08,
    ghostNoteThreshold: 0.4,    // Notes below this velocity get ghost treatment
    ghostNoteRange: [0.24, 0.39] as [number, number],
    accentRange: [0.78, 0.94] as [number, number],
    variationAmount: 0.08,
  },
  piano: {
    baseVelocityRange: [0.47, 0.86] as [number, number],
    downbeatBoost: 0.04,
    variationAmount: 0.06,
    phraseShaping: true,
  },
  bass: {
    baseVelocityRange: [0.63, 0.82] as [number, number],
    downbeatBoost: 0.06,
    variationAmount: 0.03,
  },
  synth: {
    baseVelocityRange: [0.55, 0.86] as [number, number],
    downbeatBoost: 0.04,
    variationAmount: 0.05,
  },
  default: {
    baseVelocityRange: [0.5, 0.9] as [number, number],
    downbeatBoost: 0.04,
    variationAmount: 0.05,
  },
};
```

2. Export `applyVelocityVariation(notes: NoteData[], params?: VelocityParams, rng?: () => number): NoteData[]`:

- Default params: `{ enabled: true, instrument: 'default', amount: 0.5, beatEmphasis: true }`
- If `enabled === false`, return shallow copies.
- Look up the instrument profile from `VELOCITY_PROFILES`.
- Use `createNoise2D` from `simplex-noise` for correlated velocity variation. Create the noise function using the rng if provided, otherwise Math.random.
  ```typescript
  import { createNoise2D } from 'simplex-noise';
  const noise2D = createNoise2D(rng ?? Math.random);
  ```
- For each note (by index `i`):
  a. Get base velocity from the note's existing velocity.
  b. Generate noise-based variation: `noise2D(i * 0.15, 0) * profile.variationAmount * params.amount`.
  c. If `beatEmphasis` is true, use `getBeatPosition(note.time)` to apply asymmetric emphasis:
     - Downbeat: add `profile.downbeatBoost`
     - Backbeat: no boost (or slight for drums)
     - Off-beat: subtract `profile.downbeatBoost * 0.5` (slightly softer)
  d. For drums specifically: if the resulting velocity is below `ghostNoteThreshold`, clamp it into the `ghostNoteRange`. If above the midpoint of baseVelocityRange, allow it to reach `accentRange`.
  e. For piano with `phraseShaping`: modulate velocity with a slow sine wave over the note sequence to create breathing phrasing arcs. Use `Math.sin(i * Math.PI / phraseLengthInNotes) * 0.06` where phraseLengthInNotes is ~8-16 notes.
  f. Clamp final velocity with `clampVelocity()`.
- Return new array (never mutate input).

IMPORTANT: Use `.js` extensions in all import paths.
  </action>
  <verify>
Run `npx tsc --noEmit` -- zero errors. Verify the file imports from simplex-noise correctly (ESM import of createNoise2D).
  </verify>
  <done>
velocity.ts exports `applyVelocityVariation` with 5 instrument profiles (drums, piano, bass, synth, default). Drums produce ghost notes and accents. Piano has phrase-arc breathing. Bass stays narrow. All use simplex noise for correlated variation and beat-position emphasis.
  </done>
</task>

<task type="auto">
  <name>Task 2: Note-length variation and named presets</name>
  <files>src/music/humanize/note-length.ts, src/music/humanize/presets.ts</files>
  <action>
1. Create `src/music/humanize/note-length.ts`:

Export `applyNoteLengthVariation(notes: NoteData[], params?: NoteLengthParams, rng?: () => number): NoteData[]`:

- Default params: `{ enabled: true, amount: 0.3, downbeatLegato: true }`
- If `enabled === false`, return shallow copies.
- For each note:
  a. Use `getBeatPosition(note.time)` to classify beat position.
  b. Generate a variation factor using the rng (or Math.random): `(rng?.() ?? Math.random()) * 2 - 1` gives -1 to +1.
  c. Scale by `params.amount * 0.15` (so at amount=1.0, max variation is +-15% of duration).
  d. If `downbeatLegato` is true:
     - Downbeats: bias toward positive (longer). Add `amount * 0.05` to duration.
     - Off-beats: bias toward negative (shorter). Subtract `amount * 0.03` from duration.
     - Backbeats: neutral variation.
  e. Apply: `newDuration = note.duration * (1 + variationFactor)`.
  f. Clamp: `Math.max(0.01, newDuration)` and round to 3 decimals.
  g. Ensure note doesn't extend past reasonable bounds (don't let a 0.25-beat note become 2 beats).
     Cap variation at +-30% of original duration regardless of params.
- Return new array (never mutate input).

2. Create `src/music/humanize/presets.ts`:

Export `HUMANIZATION_PRESETS` object and `getPresetParams(preset: HumanizationPreset): HumanizationParams` function.

Define presets based on RESEARCH.md recommendations:

```typescript
export const HUMANIZATION_PRESETS: Record<HumanizationPreset, HumanizationParams> = {
  tight: {
    timing: { enabled: true, theta: 0.7, sigma: 0.003, contextAware: false },
    velocity: { enabled: true, instrument: 'default', amount: 0.3, beatEmphasis: true },
    swing: { enabled: false, amount: 50 },
    noteLength: { enabled: true, amount: 0.15, downbeatLegato: true },
  },
  loose: {
    timing: { enabled: true, theta: 0.3, sigma: 0.015, contextAware: true },
    velocity: { enabled: true, instrument: 'default', amount: 0.6, beatEmphasis: true },
    swing: { enabled: true, amount: 55, gridSize: 0.25 },
    noteLength: { enabled: true, amount: 0.4, downbeatLegato: true },
  },
  jazz: {
    timing: { enabled: true, theta: 0.2, sigma: 0.020, contextAware: true },
    velocity: { enabled: true, instrument: 'default', amount: 0.7, beatEmphasis: true },
    swing: { enabled: true, amount: 66, gridSize: 0.25 },
    noteLength: { enabled: true, amount: 0.5, downbeatLegato: true },
  },
  'lo-fi': {
    timing: { enabled: true, theta: 0.15, sigma: 0.025, contextAware: false },
    velocity: { enabled: true, instrument: 'default', amount: 0.8, beatEmphasis: false },
    swing: { enabled: true, amount: 60, gridSize: 0.25 },
    noteLength: { enabled: true, amount: 0.6, downbeatLegato: false },
  },
};
```

`getPresetParams` should deep-copy the preset object (JSON.parse/stringify or structured clone) and return it. If an unknown preset is passed, throw with a clear error listing available presets.

Key characteristics that make presets DISTINCT:
- **tight**: Fast reversion (0.7 theta), tiny drift (0.003 sigma), no swing, minimal variation. For electronic/pop where precision matters but notes shouldn't be robotic.
- **loose**: Slow reversion, moderate drift, slight swing (55%), context-aware. For relaxed performances.
- **jazz**: Very slow reversion, wide drift, triplet swing (66%), high velocity variation, context-aware. For jazz/soul/neo-soul feel.
- **lo-fi**: Minimal reversion (notes wander), large sigma, moderate swing, high variation, NO beat emphasis (intentionally unanchored feel), NO downbeat legato.

IMPORTANT: Use `.js` extensions in all import paths.
  </action>
  <verify>
Run `npx tsc --noEmit` -- zero errors. Verify presets.ts correctly references all HumanizationParams sub-types.
  </verify>
  <done>
note-length.ts exports `applyNoteLengthVariation` with beat-position-aware legato/staccato. presets.ts exports 4 named presets (tight, loose, jazz, lo-fi) that produce distinctly different humanization character through different parameter combinations.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` compiles with zero errors
2. All 3 new files use `.js` extension in import paths
3. VELOCITY_PROFILES matches researched values (drums ghost 0.24-0.39, accent 0.78-0.94)
4. Each preset has distinctly different theta, sigma, swing amount, and variation amounts
5. No file conflicts with Plan 01 -- these files are entirely new
</verification>

<success_criteria>
- velocity.ts provides instrument-aware velocity variation for drums, piano, bass, synth, default
- note-length.ts provides beat-position-aware duration variation with downbeat legato
- presets.ts defines 4 named presets with distinctly different parameters
- All transforms accept optional seeded RNG for reproducibility
- Project compiles cleanly with `npx tsc --noEmit`
</success_criteria>

<output>
After completion, create `.planning/phases/03-humanization-engine/03-02-SUMMARY.md`
</output>
